<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Open Software for Restricted Data: an Environmental Epidemiology example</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="Open Software for Restricted Data: an Environmental Epidemiology example"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2013-11-14T21:03+1100"/>
<meta name="author" content="Ivan Hanigan, Steven McEachern and David Fisher "/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">Open Software for Restricted Data: an Environmental Epidemiology example</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Abstract</a></li>
<li><a href="#sec-2">2 Introduction /introduction.html</a></li>
<li><a href="#sec-3">3 Deploying Virtual Machines</a>
<ul>
<li><a href="#sec-3-1">3.1 Description</a></li>
<li><a href="#sec-3-2">3.2 Accessing Virtual Machines on the Australian  Research Cloud</a>
<ul>
<li><a href="#sec-3-2-1">3.2.1 Launch an instance</a></li>
<li><a href="#sec-3-2-2">3.2.2 security-groups header</a></li>
<li><a href="#sec-3-2-3">3.2.3 requesting help</a></li>
<li><a href="#sec-3-2-4">3.2.4 connect using ssh</a></li>
</ul>
</li>
<li><a href="#sec-3-3">3.3 Setting up the basic server framework</a>
<ul>
<li><a href="#sec-3-3-1">3.3.1 Install any updates using the yum package manager</a></li>
</ul>
</li>
<li><a href="#sec-3-4">3.4 Security measures</a>
<ul>
<li><a href="#sec-3-4-1">3.4.1 Restrict ssh access to a specific ip address/range</a></li>
</ul>
</li>
<li><a href="#sec-3-5">3.5 Setting the host.* TCP Wrappers</a>
<ul>
<li><a href="#sec-3-5-1">3.5.1 Setting the host.* TCP Wrappers header</a></li>
<li><a href="#sec-3-5-2">3.5.2 Security Enhanced Linux (selinux)</a></li>
<li><a href="#sec-3-5-3">3.5.3 Install some base packages</a></li>
</ul>
</li>
<li><a href="#sec-3-6">3.6 Hardware set-up</a>
<ul>
<li><a href="#sec-3-6-1">3.6.1 Swap space /swapon.html</a></li>
<li><a href="#sec-3-6-2">3.6.2 Persistent Net Rules Should Be Avoided On Centos</a></li>
<li><a href="#sec-3-6-3">3.6.3 Disk Storage</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-4">4 The Brawn</a>
<ul>
<li><a href="#sec-4-1">4.1 OpenGeo Suite (Postgres and friends)</a>
<ul>
<li><a href="#sec-4-1-1">4.1.1 Restricted OpenGeo Suite /opengeosuite-restricted.html</a></li>
</ul>
</li>
<li><a href="#sec-4-2">4.2 Postgres standalone</a>
<ul>
<li><a href="#sec-4-2-1">4.2.1 PostgreSQL /postgresql.html</a></li>
<li><a href="#sec-4-2-2">4.2.2 PostGIS 2.0 /postgis.html</a></li>
<li><a href="#sec-4-2-3">4.2.3 PostgreSQL Migration /postgres-migrate.html</a></li>
</ul>
</li>
<li><a href="#sec-4-3">4.3 Tuning Postgres Performance</a>
<ul>
<li><a href="#sec-4-3-1">4.3.1 Important shared memory settings /sharedmemory.html</a></li>
<li><a href="#sec-4-3-2">4.3.2 Postgres conf</a></li>
<li><a href="#sec-4-3-3">4.3.3 Test loading some shapefiles</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-5">5 The Brains</a>
<ul>
<li><a href="#sec-5-1">5.1 R Server</a>
<ul>
<li><a href="#sec-5-1-1">5.1.1 R</a></li>
<li><a href="#sec-5-1-2">5.1.2 package management and R updates</a></li>
<li><a href="#sec-5-1-3">5.1.3 Rstudio</a></li>
<li><a href="#sec-5-1-4">5.1.4 firewall access</a></li>
<li><a href="#sec-5-1-5">5.1.5 SSL/HHTPS and running a proxy server</a></li>
<li><a href="#sec-5-1-6">5.1.6 git</a></li>
<li><a href="#sec-5-1-7">5.1.7 ssh for github</a></li>
<li><a href="#sec-5-1-8">5.1.8 gdal</a></li>
<li><a href="#sec-5-1-9">5.1.9 geos</a></li>
<li><a href="#sec-5-1-10">5.1.10 or under ubuntu</a></li>
<li><a href="#sec-5-1-11">5.1.11 test readOGR</a></li>
<li><a href="#sec-5-1-12">5.1.12 rgraphviz</a></li>
<li><a href="#sec-5-1-13">5.1.13 test</a></li>
<li><a href="#sec-5-1-14">5.1.14 install just the postgres bits required for RPostgreSQL package</a></li>
<li><a href="#sec-5-1-15">5.1.15 postgis utilities</a></li>
<li><a href="#sec-5-1-16">5.1.16 unixODBC</a></li>
</ul>
</li>
<li><a href="#sec-5-2">5.2 Test the Backups of this Minimal R Sever.</a>
<ul>
<li><a href="#sec-5-2-1">5.2.1 Backup the 2nd Disc</a></li>
<li><a href="#sec-5-2-2">5.2.2 Launch from this snapshot and test the R server and 2nd Disc</a></li>
<li><a href="#sec-5-2-3">5.2.3 the permissions of the user on their home directory cause issues for logging in.</a></li>
</ul>
</li>
<li><a href="#sec-5-3">5.3 Oracle XE Permissions and Users System</a>
<ul>
<li><a href="#sec-5-3-1">5.3.1 backup local ubuntu version</a></li>
<li><a href="#sec-5-3-2">5.3.2 INIT</a></li>
<li><a href="#sec-5-3-3">5.3.3 SWAP</a></li>
<li><a href="#sec-5-3-4">5.3.4 DOWNLOAD AND SCP</a></li>
<li><a href="#sec-5-3-5">5.3.5 Install the database</a></li>
<li><a href="#sec-5-3-6">5.3.6 import application and set Security</a></li>
<li><a href="#sec-5-3-7">5.3.7 explain the table creation script</a></li>
<li><a href="#sec-5-3-8">5.3.8 set up R, RJDBC and ROracle</a></li>
<li><a href="#sec-5-3-9">5.3.9 maintenance</a></li>
</ul>
</li>
<li><a href="#sec-5-4">5.4 unlock</a>
<ul>
<li><a href="#sec-5-4-1">5.4.1 unlock header</a></li>
</ul>
</li>
<li><a href="#sec-5-5">5.5 DDIindex</a>
<ul>
<li><a href="#sec-5-5-1">5.5.1 TOMCAT</a></li>
<li><a href="#sec-5-5-2">5.5.2 UPLOAD THE DDIINDEX</a></li>
<li><a href="#sec-5-5-3">5.5.3 MySQL</a></li>
<li><a href="#sec-5-5-4">5.5.4 make sure ddiindex can connect to mysql as ddiindex user</a></li>
<li><a href="#sec-5-5-5">5.5.5 Check the security implications of allowing write permissions here</a></li>
<li><a href="#sec-5-5-6">5.5.6 Running the Indexer</a></li>
<li><a href="#sec-5-5-7">5.5.7 personalise the ddiindex</a></li>
</ul>
</li>
<li><a href="#sec-5-6">5.6 Set up a private git server for data and code</a></li>
<li><a href="#sec-5-7">5.7 True-Crypt encrypted volumes</a></li>
<li><a href="#sec-5-8">5.8 ResearchData storage</a></li>
</ul>
</li>
<li><a href="#sec-6">6 Procedures for add users to the system.</a>
<ul>
<li><a href="#sec-6-1">6.1 Description of the access procedure</a>
<ul>
<li><a href="#sec-6-1-1">6.1.1 Getting Access</a></li>
<li><a href="#sec-6-1-2">6.1.2 Managing Access</a></li>
<li><a href="#sec-6-1-3">6.1.3 Ending Access</a></li>
</ul>
</li>
<li><a href="#sec-6-2">6.2 The process user administrators go through to set up users</a>
<ul>
<li><a href="#sec-6-2-1">6.2.1 lodge request in user db</a></li>
<li><a href="#sec-6-2-2">6.2.2 r-nceph</a></li>
</ul>
</li>
<li><a href="#sec-6-3">6.3 brains</a>
<ul>
<li><a href="#sec-6-3-1">6.3.1 linux user</a></li>
<li><a href="#sec-6-3-2">6.3.2 mysql (check ddiindex)</a></li>
</ul>
</li>
<li><a href="#sec-6-4">6.4 brawn</a>
<ul>
<li><a href="#sec-6-4-1">6.4.1 postgres</a></li>
<li><a href="#sec-6-4-2">6.4.2 geoserver</a></li>
<li><a href="#sec-6-4-3">6.4.3 alliance wiki</a></li>
<li><a href="#sec-6-4-4">6.4.4 email details without password</a></li>
<li><a href="#sec-6-4-5">6.4.5 text message the set password</a></li>
</ul>
</li>
<li><a href="#sec-6-5">6.5 edits to oraphi via sql</a>
<ul>
<li><a href="#sec-6-5-1">6.5.1 revocation</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-7">7 Backups</a>
<ul>
<li><a href="#sec-7-1">7.1 General</a>
<ul>
<li><a href="#sec-7-1-1">7.1.1 maintenance</a></li>
<li><a href="#sec-7-1-2">7.1.2 nearline for potential restore</a></li>
<li><a href="#sec-7-1-3">7.1.3 archive and remove</a></li>
</ul>
</li>
<li><a href="#sec-7-2">7.2 General concerns</a></li>
<li><a href="#sec-7-3">7.3 Brains</a>
<ul>
<li><a href="#sec-7-3-1">7.3.1 Backup oraphi</a></li>
</ul>
</li>
<li><a href="#sec-7-4">7.4 Brawn</a>
<ul>
<li><a href="#sec-7-4-1">7.4.1 Find out how big is it?</a></li>
<li><a href="#sec-7-4-2">7.4.2 Dump and download it to a secure computer</a></li>
<li><a href="#sec-7-4-3">7.4.3 Restore databse dump into a new database on another machine.</a></li>
<li><a href="#sec-7-4-4">7.4.4 launch a new Nectar VM from the snapshot image</a></li>
<li><a href="#sec-7-4-5">7.4.5 mount the 2nd disc and load/restore the postgres db and data into it</a></li>
</ul>
</li>
<li><a href="#sec-7-5">7.5 Disaster Recovery Plan</a>
<ul>
<li><a href="#sec-7-5-1">7.5.1 test a snapshot</a></li>
<li><a href="#sec-7-5-2">7.5.2 60GB disk is not being saved in snapshots</a></li>
<li><a href="#sec-7-5-3">7.5.3 Restore ORAPHI</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-8">8 Examples</a>
<ul>
<li><a href="#sec-8-1">8.1 Pumilio for Bioacoustics</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Abstract</h2>
<div class="outline-text-2" id="text-1">


<div class="abstract">
<p>Ivan Hanigan 1, Steven McEachern 2, David Fisher 3.
</p>

<ul>
<li>1 National Centre for Epidemiology and Population Health, Australian National University
</li>
<li>2 Australian Data Archive, Australian National University
</li>
<li>3 Information Technology Services, Australian National University
</li>
</ul>


<p>
Last Updated 8 March 2013
</p>
<p>
Increasing concerns over privacy in Australia and globally, combined
with the risk from hacking and the accidental release of large-scale
data sets is leading to increased restrictions on the use of
confidential, highly sensitive health data. This is coincident with
increased statistical and computational power, with the potential to
glean many new insights from already collected data. Unfortunately,
however, the two trends risk cancelling each other out. It is thus
imperative that universities and other institutions who have access to
large data sets manage them in ways that maintain organisational and
public confidence in their integrity.
</p>
<p>
This paper presents the design and development of a Virtual Laboratory
for analysing restricted data using open software.  These tools were
assembled with the aim to allow users to access restricted data in an
appropriate and safe manner whilst allowing use of open software to
enhance reproducibility and accessibility.  The system implementation
is described specifically for the Australian National Research Cloud
<a href="http://www.nectar.org.au/research-cloud/">http://www.nectar.org.au/research-cloud/</a>.
</p>
<p>
We present a case study of an application from Environmental
Epidemiology using confidential health records, which was a motivating
reason for us to develop this system.  In the example presented here,
we provide a simple analysis of the distribution of suicides with
drought across NSW and also with votes for the conservative parties;
both of which have previously been found to increase the risk of
suicides in NSW. The paper then concludes with a reflection on the
implications of applying these open software tools to restricted
access data such as the Australian Deaths dataset.
</p>
</div>

<hr/>

















</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Introduction /introduction.html</h2>
<div class="outline-text-2" id="text-2">







<pre class="src src-markdown">We present an environment for analysing restricted data using open
software.  The system is described using an analysis of the historical
association of suicides with drought in Australia; and extrapolate
this under climate change and adaptation scenarios.  These tools were
assembled to allow users to access restricted data in a manner that
protects confidentiality of sensitive data, whilst also allowing use
of open software for reproducibility. 

Recently restrictions on access to confidential health records have
increased, especially for  sensitive data on suicide used in our
case study.  Previous solutions to this challenge make access 
so restricted that usability is compromised. We aimed to build a
collection of tools for the conduct of many types of health and social
science research. The starting point for users is the data catalogue,
which provides for finding data available from the store of
unrestricted and restricted data for approved use. Once data are
discovered, the researcher has capacity to manipulate the datasets on
the secure server. The PostgreSQL database integrates and Geoserver
visualises, while statistical tools are available in the R-studio
server browser.

Such analytical tools will enhance the
ability of adaptive management practitioners to assess the potential
influence of adaptations.  The use of the system shows the ease with
which multiple data sources (some restricted) can be analysed in a
secure way using open software.  This will build capacity to answer
complex research questions and compare multiple climate change
scenarios or adaptation assumptions; achieving simultaneous vision of
potential future outcomes from different standpoints.
</pre>


</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Deploying Virtual Machines</h2>
<div class="outline-text-2" id="text-3">


</div>

<div id="outline-container-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Description</h3>
<div class="outline-text-3" id="text-3-1">

<p>We want to deploy the service as a symbiotic pair of virtual images that together will provide integrated data storage and analysis services in the cloud.
Our recent review of the system prototype I developed suggested a need for two servers to comprise this system; to provide a more robust and powerful combination of structural and functional aspects.
</p>
<p>
The services hosted by the pair of servers will be:
</p><ul>
<li>The Brains: a Statistical Analysis engine (running the R environment) integrated with a metadata registry, and
</li>
<li>The Brawn: a PostgreSQL Geographical Information System (GIS) Database server.
</li>
</ul>


</div>

</div>

<div id="outline-container-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Accessing Virtual Machines on the Australian  Research Cloud</h3>
<div class="outline-text-3" id="text-3-2">


</div>

<div id="outline-container-3-2-1" class="outline-4">
<h4 id="sec-3-2-1"><span class="section-number-4">3.2.1</span> Launch an instance</h4>
<div class="outline-text-4" id="text-3-2-1">

<ul>
<li>Log on to the research cloud using your Australian University details <a href="http://www.nectar.org.au/research-cloud/">http://www.nectar.org.au/research-cloud/</a>.
</li>
<li>create two security groups for brawn and brains, this will be the special firewall settings for each
</li>
<li>add ssh port 22 (add http(s): 80 etc, postgres 5432, icmp -1 as needed)
</li>
<li>Under images and snapshots launch the centos 6.2 amd64 image
</li>
<li>give your server a name, add security group
</li>
<li>specify a ssh keypair <a href="http://support.rc.nectar.org.au/demos/launching_123.html">http://support.rc.nectar.org.au/demos/launching_123.html</a>
</li>
<li>launch and note the ip address
</li>
<li>go to the access and security section and edit the rules (ie for http add a rule to allow access from port 8080 to 9000 with 0.0.0.0/0 (CIDR))
</li>
<li>Note that this allows access to the whole world, we will think about securing the server later
</li>
</ul>


</div>

</div>

<div id="outline-container-3-2-2" class="outline-4">
<h4 id="sec-3-2-2"><span class="section-number-4">3.2.2</span> security-groups header</h4>
<div class="outline-text-4" id="text-3-2-2">



</div>

</div>

<div id="outline-container-3-2-3" class="outline-4">
<h4 id="sec-3-2-3"><span class="section-number-4">3.2.3</span> requesting help</h4>
<div class="outline-text-4" id="text-3-2-3">

<p>To: rc-support@nectar.org.au
Subject: Request about snapshot status
</p>
<p>
Hi,
</p>
<p>
My AAF email I login to the cloud with is: ivan.hanigan@anu.edu.au
</p>
<p>
What is currently happening:
I took a snapshot of one VM and it said success but now in the status column it has 'shutoff' and a spinning wheel.
</p>
<p>
What should happen:
It should return to status 'Active'.
</p>
<p>
Cheers,
Ivan Hanigan
Data Management Officer.
Thursday PhD scholar (ANU/CSIRO).
National Centre for Epidemiology and Population Health.
College of Medicine, Biology and Environment.
Australian National University Canberra, ACT, 0200.
Ph: +61 2 6125 7767.
Fax: +61 2 6125 0740.
Mob: 0428 265 976.
CRICOS provider #00120C.
</p></div>

</div>

<div id="outline-container-3-2-4" class="outline-4">
<h4 id="sec-3-2-4"><span class="section-number-4">3.2.4</span> connect using ssh</h4>
<div class="outline-text-4" id="text-3-2-4">

<p>If using Windows make sure you have git or WinSCP installed.  Opening a bash
shell from these will enable you to connect to your server using ssh. Then the contents of the following orgmode chunks can be evaluated on the remote server.
If your on linux then orgmode can execute these chunks using C-c C-c.
</p>


<pre class="src src-sh">whoami
</pre>

<p>
In the next chunk, insert the relevant ip address and you may have to answer yes to the question about adding this RSA fingerprint to your list.
</p>


<pre class="src src-sh"><span style="color: #839496; font-weight: bold;">cd</span> ~/.ssh
ssh -i keypairname root@your.new.ip.address
<span style="color: #586e75;"># </span><span style="color: #586e75;">it is prudent to set a hideously long password for root</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">passwd root</span>
</pre>



</div>
</div>

</div>

<div id="outline-container-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Setting up the basic server framework</h3>
<div class="outline-text-3" id="text-3-3">

<p>This is done in a similar way for both the Brains and the Brawn servers.
</p>
</div>

<div id="outline-container-3-3-1" class="outline-4">
<h4 id="sec-3-3-1"><span class="section-number-4">3.3.1</span> Install any updates using the yum package manager</h4>
<div class="outline-text-4" id="text-3-3-1">

<p>This is recommended to do every week to maintain the server in good condition, especially regarding security software. 
</p>


<pre class="src src-sh">yum update 
</pre>

</div>
</div>

</div>

<div id="outline-container-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Security measures</h3>
<div class="outline-text-3" id="text-3-4">

<p>The following section sets some restrictions on the server.
I would like to know how important it is to restrict root login and also if we can permit login via ssh and port 22 if it is only open to the NCEPH VPN range?  If so I just leave the below as yes yes yes?
I had to get a bit of advice from a sysadmin at work about the following but I am sure it is still pretty unsecure.  
There are various TODOs hidden in the source code document.
</p>



<pre class="src src-sh"><span style="color: #586e75;">################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">name:security</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">visit </span>
/etc/ssh/sshd_config
<span style="color: #586e75;">#</span><span style="color: #586e75;">under authentication remark out </span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">RSAAuthentication yes</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">PubkeyAuthentication yes</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">AuthorizedKeysFile     .ssh/authorized_keys</span>
</pre>




</div>

<div id="outline-container-3-4-1" class="outline-4">
<h4 id="sec-3-4-1"><span class="section-number-4">3.4.1</span> Restrict ssh access to a specific ip address/range</h4>
<div class="outline-text-4" id="text-3-4-1">




</div>
</div>

</div>

<div id="outline-container-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> Setting the host.* TCP Wrappers</h3>
<div class="outline-text-3" id="text-3-5">


</div>

<div id="outline-container-3-5-1" class="outline-4">
<h4 id="sec-3-5-1"><span class="section-number-4">3.5.1</span> Setting the host.* TCP Wrappers header</h4>
<div class="outline-text-4" id="text-3-5-1">



</div>

</div>

<div id="outline-container-3-5-2" class="outline-4">
<h4 id="sec-3-5-2"><span class="section-number-4">3.5.2</span> Security Enhanced Linux (selinux)</h4>
<div class="outline-text-4" id="text-3-5-2">

<p>To run the Database and the Rstudio server it is best to disable the selinux.  
</p><ul>
<li id="sec-3-5-2-1"><span class="todo TODO">TODO</span> Find out if this is necessary for PostgreSQL as well as Rstudio.<br/>



<pre class="src src-sh"><span style="color: #586e75;"># </span><span style="color: #586e75;">selinux config</span>
vi /etc/selinux/config
<span style="color: #586e75;"># </span><span style="color: #586e75;">This file controls the state of SELinux on the system.</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">SELINUX= can take one of these three values:</span>
<span style="color: #586e75;">#     </span><span style="color: #586e75;">enforcing - SELinux security policy is enforced.</span>
<span style="color: #586e75;">#     </span><span style="color: #586e75;">permissive - SELinux prints warnings instead of enforcing.</span>
<span style="color: #586e75;">#     </span><span style="color: #586e75;">disabled - No SELinux policy is loaded.</span>
<span style="color: #268bd2;">SELINUX</span>=enforcing
<span style="color: #586e75;"># </span><span style="color: #586e75;">Change SELINUX=enforcing to disabled</span>
</pre>



</li>
</ul>
</div>

</div>

<div id="outline-container-3-5-3" class="outline-4">
<h4 id="sec-3-5-3"><span class="section-number-4">3.5.3</span> Install some base packages</h4>
<div class="outline-text-4" id="text-3-5-3">

<p>There are a few commonly used packages recommended for both Brawn and Brains.
</p>


<pre class="src src-sh">yum install gcc-gfortran gcc-c++ readline-devel libpng-devel libX11-devel libXt-devel texinfo-tex.x86_64 tetex-dvips docbook-utils-pdf cairo-devel java-1.6.0-openjdk-devel libxml2-devel make unzip hdparm
</pre>

</div>
</div>

</div>

<div id="outline-container-3-6" class="outline-3">
<h3 id="sec-3-6"><span class="section-number-3">3.6</span> Hardware set-up</h3>
<div class="outline-text-3" id="text-3-6">

<p>Now we will note the size and number of the disc partitions.
</p>


<pre class="src src-sh">df -h
</pre>


</div>

<div id="outline-container-3-6-1" class="outline-4">
<h4 id="sec-3-6-1"><span class="section-number-4">3.6.1</span> Swap space /swapon.html</h4>
<div class="outline-text-4" id="text-3-6-1">




<pre class="src src-markdown"><span style="color: #268bd2; font-weight: bold;">--- </span>
<span style="color: #268bd2;">name</span>: <span style="color: #2aa198;">swapon</span>
<span style="color: #268bd2;">layout</span>: <span style="color: #2aa198;">default</span>
<span style="color: #268bd2; font-size: 140%; font-weight: bold;">title: Swap space</span>
<span style="color: #268bd2; font-weight: bold;">---</span>

For some reason the Research Cloud Centos VMs do not have any swap space.
I added one GB swapfile, but was advised to enable about the same amount as we have RAM.
I will come back and review this, also I was too lazy to add to boot so just do swapon every time?
</pre>



<pre class="src src-sh"><span style="color: #586e75;">#### </span><span style="color: #586e75;">Code</span>
    free -m | grep Swap
</pre>



<pre class="src src-markdown"><span style="color: #268bd2;">Add swap file with this</span>:
</pre>



<pre class="src src-sh"><span style="color: #586e75;">#### </span><span style="color: #586e75;">Code</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">Create an empty file called /swapfile (here over 2 GB is required for oracle but for just one GB it is count = 1024, need to come back and review)</span>
    dd <span style="color: #268bd2;">if</span>=/dev/zero <span style="color: #268bd2;">of</span>=/swapfile <span style="color: #268bd2;">bs</span>=1024000 <span style="color: #268bd2;">count</span>=3000
    <span style="color: #586e75;">#</span><span style="color: #586e75;">Format the new file to make it a swap file</span>
    mkswap /swapfile
    <span style="color: #586e75;">#</span><span style="color: #586e75;">Enable the new swapfile. </span>
    swapon /swapfile
    free -m | grep Swap
</pre>


</div>

</div>

<div id="outline-container-3-6-2" class="outline-4">
<h4 id="sec-3-6-2"><span class="section-number-4">3.6.2</span> Persistent Net Rules Should Be Avoided On Centos</h4>
<div class="outline-text-4" id="text-3-6-2">

<p>The current "CentOS 6.2 amd64" image (ID 21401), if launched and
snapshotted, is not connectible when launched from this snapshot due
to networking.  (davidjb, Mon Mar 26, 2012 support.rc.nectar.org.au/forum).
</p>



<pre class="src src-R"><span style="color: #586e75;">################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">name:netrulses</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">Just remove the /lib/udev/write_net_rules file (and</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">/etc/udev/rules.d/70-persistent-net.rules for good measure), and then</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">any further instances will always have their networking adapter as</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">eth0. There's probably a better way to do this, but that's working for</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">me now</span>
rm /lib/udev/write_net_rules
rm /etc/udev/rules.d/70-persistent-net.rules
</pre>



</div>

</div>

<div id="outline-container-3-6-3" class="outline-4">
<h4 id="sec-3-6-3"><span class="section-number-4">3.6.3</span> Disk Storage</h4>
<div class="outline-text-4" id="text-3-6-3">

<p>Every VM on the Research Cloud has a 10GB primary disk which is used for the image you launch. The Primary disk is copied in a snapshot, so anything on this primary disk can be backed up via snapshots.  In addition every Virtual Machine will get secondary storage. This secondary disk is not copied or backed up via snapshots.  If you reboot your virtual machine, the secondary disk data remains in tact. If you shut down your VM, the data disappears (it is not persistent).
</p>




<pre class="src src-sh"><span style="color: #586e75;">######################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">Mount the drive to /home eg.</span>
mount -t ext3 /dev/vdb /home
<span style="color: #586e75;"># </span><span style="color: #586e75;">df -h</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">once successful edit /etc/fstab to mount the drive at boot e.g.</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">/dev/vdb    /home    ext3     defaults    0 0</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">Reboot the server to ensure that the drive mounts on boot.</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">check performance</span>
hdparm -tT /dev/vdb
</pre>



<ul>
<li id="sec-3-6-3-1"><span class="todo TODO">TODO</span> find out recommended practice for backups, and purpose of 'object storage'<br/>
<ul>
<li><a href="http://support.rc.nectar.org.au/technical_guides/object_storage.html">http://support.rc.nectar.org.au/technical_guides/object_storage.html</a>
</li>
<li>go to settings (topright), EC2 credentials, select project  and download zip
</li>
<li>unzip and open ec2rc.sh in text editor
</li>
<li>sudo apt-get install python-boto
</li>
<li>list existing buckets
</li>
</ul>

<p>import boto.s3.connection
</p>
<p>
connection = boto.s3.connection.S3Connection(
aws<sub>access</sub><sub>key</sub><sub>id</sub>='7b7a0a6f71994e42a07c8e9b0de0f8ca',
aws<sub>secret</sub><sub>access</sub><sub>key</sub>='2d54f6a679cd4b06820550459451cb50',
port=8888,
host='swift.rc.nectar.org.au',
is<sub>secure</sub>=True,
calling<sub>format</sub>=boto.s3.connection.OrdinaryCallingFormat())
</p>
<p>
buckets = connection.get<sub>all</sub><sub>buckets</sub>()
print buckets
</p><ul>
<li>downside is you have to use python to work with the data?
</li>
</ul>





</li>
</ul>
</div>
</div>
</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> The Brawn</h2>
<div class="outline-text-2" id="text-4">

<p>The Brawn is a PostgreSQL Geographical Information System (GIS) Database server.
</p>
</div>

<div id="outline-container-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> OpenGeo Suite (Postgres and friends)</h3>
<div class="outline-text-3" id="text-4-1">


</div>

<div id="outline-container-4-1-1" class="outline-4">
<h4 id="sec-4-1-1"><span class="section-number-4">4.1.1</span> Restricted OpenGeo Suite /opengeosuite-restricted.html</h4>
<div class="outline-text-4" id="text-4-1-1">

<ul>
<li id="sec-4-1-1-1">The OpenGeo Suite Installer<br/>



<pre class="src src-markdown"><span style="color: #268bd2; font-weight: bold;">--- </span>
<span style="color: #268bd2;">name</span>: <span style="color: #2aa198;">opengeosuite-restricted</span>
<span style="color: #268bd2;">layout</span>: <span style="color: #2aa198;">default</span>
<span style="color: #268bd2; font-size: 140%; font-weight: bold;">title: Restricted OpenGeo Suite</span>
<span style="color: #268bd2; font-weight: bold;">---</span>

  &lt;li&gt;&lt;a href="#sec-5-3-8"&gt;TODO Previous: &lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href="/opengeosuite-upgrade-tomcat6.html"&gt;Next: Disable Tomcat&lt;/a&gt;&lt;/li&gt;
&lt;p&gt;&lt;/p&gt;

The OpenGeo Suite provides a complete spatial data server software stack.  I use this for the batch install and configuration (TODO look into the individual components offered by OpenGeo). I don't want the Brawn server to run the tomcat etc.  <span style="color: #859900; font-weight: bold;">[Installation instructions are here]</span><span style="color: #2aa198;">(http://suite.opengeo.org/opengeo-docs/installation/linux/centos/suite.html)</span> but beware that the Redhat version requires the optional channel to be enabled. 

</pre>



<pre class="src src-markdown"><span style="color: #268bd2; font-weight: bold;">####</span> <span style="color: #268bd2; font-size: 130%; font-weight: bold;">Code Centos</span>
<span style="color: #268bd2; font-weight: bold;">    # find out your os</span>
<span style="color: #268bd2; font-weight: bold;">    cat /etc/issue</span>
<span style="color: #268bd2; font-weight: bold;">    uname -r</span>
<span style="color: #268bd2; font-weight: bold;">    # if centos</span>
<span style="color: #268bd2; font-weight: bold;">    cd /etc/yum.repos.d</span>
<span style="color: #268bd2; font-weight: bold;">    wget http://yum.opengeo.org/suite/v3/centos/6/x86_64/OpenGeo.repo</span>
<span style="color: #268bd2; font-weight: bold;">    yum install opengeo-suite</span>
</pre>



<pre class="src src-markdown"><span style="color: #268bd2; font-weight: bold;">####</span> <span style="color: #268bd2; font-size: 130%; font-weight: bold;">Code Redhat</span>
<span style="color: #268bd2; font-weight: bold;">    cd /etc/yum.repos.d</span>
<span style="color: #268bd2; font-weight: bold;">    wget http://yum.opengeo.org/suite/v3/rhel/6/x86_64/OpenGeo.repo</span>
<span style="color: #268bd2; font-weight: bold;">    yum install opengeo-suite</span>
</pre>


</li>
</ul>
<ul>
<li id="sec-4-1-1-2">Upgrade tomcat6<br/>







<pre class="src src-markdown"><span style="color: #268bd2; font-weight: bold;">####</span> <span style="color: #268bd2; font-size: 130%; font-weight: bold;">Code</span>
<span style="color: #268bd2; font-weight: bold;">    service tomcat6 stop</span>
<span style="color: #268bd2; font-weight: bold;">    chkconfig tomcat6 off</span>
<span style="color: #268bd2; font-weight: bold;">    cd /usr/share          </span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    wget http://mirror.overthewire.com.au/pub/apache/tomcat/tomcat-6/v6.0.37/bin/apache-tomcat-6.0.37.tar.gz</span>

<span style="color: #268bd2; font-weight: bold;">    tar -xzf apache-tomcat-6.0.37.tar.gz</span>
<span style="color: #268bd2; font-weight: bold;">    #To start Tomcat, go to the bin folder of Tomcat installation and then run the startup.sh script,</span>
<span style="color: #268bd2; font-weight: bold;">    cd /usr/share/apache-tomcat-6.0.37</span>
<span style="color: #268bd2; font-weight: bold;">    vi conf/server.xml</span>
<span style="color: #268bd2; font-weight: bold;">    # change &lt;Connector port="8081"/&gt; from 8080</span>
<span style="color: #268bd2; font-weight: bold;">    # use vi /etc/sysconfig/iptables to check this port is open in firewall</span>

<span style="color: #268bd2; font-weight: bold;">    vi conf/tomcat-users.xml</span>
<span style="color: #268bd2; font-weight: bold;">    #if you want to use the manager, I did not for security reasons</span>
<span style="color: #268bd2; font-weight: bold;">    #add a user with roles of admin,manager-gui like this</span>
<span style="color: #268bd2; font-weight: bold;">    #&lt;role rolename="manager-gui"/&gt;</span>
<span style="color: #268bd2; font-weight: bold;">    #&lt;user username="tomcat" password="s3cret" roles="manager-gui"/&gt;</span>
<span style="color: #268bd2; font-weight: bold;">    </span>
<span style="color: #268bd2; font-weight: bold;">    #To start Tomcat, go to the bin folder of Tomcat installation and then run the startup.sh script,</span>
<span style="color: #268bd2; font-weight: bold;">    ./bin/startup.sh   </span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    ./bin/shutdown.sh</span>

<span style="color: #268bd2; font-weight: bold;">    # make a script for starting</span>
<span style="color: #268bd2; font-weight: bold;">    cd /etc/init.d</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    vi tomcat</span>
<span style="color: #268bd2; font-weight: bold;">    # add this</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    # to find java_home "update-alternatives --display java" and remove bin/java</span>
<span style="color: #268bd2; font-weight: bold;">    ####</span>
<span style="color: #268bd2; font-weight: bold;">    #!/bin/bash</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    # description: Tomcat Start Stop Restart</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    # processname: tomcat</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    # chkconfig: 234 20 80</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    JAVA_HOME=/usr/lib/jvm/jre-1.6.0-openjdk.x86_64</span>
<span style="color: #268bd2; font-weight: bold;">    export JAVA_HOME</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    PATH=$JAVA_HOME/bin:$PATH</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    export PATH</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    CATALINA_HOME=/usr/share/apache-tomcat-6.0.37</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">      </span>
<span style="color: #268bd2; font-weight: bold;">    case $1 in</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    start)</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    sh $CATALINA_HOME/bin/startup.sh</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    ;; </span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    stop)   </span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    sh $CATALINA_HOME/bin/shutdown.sh</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    ;; </span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    restart)</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    sh $CATALINA_HOME/bin/shutdown.sh</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    sh $CATALINA_HOME/bin/startup.sh</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    ;; </span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    esac    </span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    exit 0</span>
<span style="color: #268bd2; font-weight: bold;">    ####</span>

<span style="color: #268bd2; font-weight: bold;">    # now</span>
<span style="color: #268bd2; font-weight: bold;">    chmod 755 tomcat</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    chkconfig --add tomcat</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    chkconfig --level 234 tomcat on</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    # verify</span>
<span style="color: #268bd2; font-weight: bold;">    chkconfig --list tomcat</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    service tomcat start</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    # test stop, start, restart</span>
<span style="color: #268bd2; font-weight: bold;">    more /usr/share/apache-tomcat-6.0.37/logs/catalina.out</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    # to check for errors, but is all greek to me</span>
<span style="color: #268bd2; font-weight: bold;">    # so assuming ddiindex was previously running on tomcat6</span>
<span style="color: #268bd2; font-weight: bold;">    service tomcat stop</span>


<span style="color: #268bd2; font-weight: bold;">    cd /usr/share/tomcat6/webapps</span>
<span style="color: #268bd2; font-weight: bold;">    cp -r dashboard /usr/share/apache-tomcat-6.0.37/webapps</span>
<span style="color: #268bd2; font-weight: bold;">    cp -r geowebcache /usr/share/apache-tomcat-6.0.37/webapps</span>
<span style="color: #268bd2; font-weight: bold;">    cp -r geoserver /usr/share/apache-tomcat-6.0.37/webapps  </span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    cp -r opengeo-docs /usr/share/apache-tomcat-6.0.37/webapps      </span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    cp -r geoexplorer /usr/share/apache-tomcat-6.0.37/webapps          </span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    cp -r recipes /usr/share/apache-tomcat-6.0.37/webapps              </span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    cd /usr/share/apache-tomcat-6.0.37</span>
<span style="color: #268bd2; font-weight: bold;">    service tomcat start</span>

<span style="color: #268bd2; font-weight: bold;">    #now you have installed the suite go into the geoserver website</span><span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
<span style="color: #268bd2; font-weight: bold;">    # http://ip.address.of.server:8081/dashboard</span>
<span style="color: #268bd2; font-weight: bold;">    # then go to the geoserver and log in as admin with password geoserver</span>
<span style="color: #268bd2; font-weight: bold;">    # follow instructions there to enhance the security</span>

<span style="color: #268bd2; font-weight: bold;">    # for The default user/group service should use digest password encoding see</span>
<span style="color: #268bd2; font-weight: bold;">    #  http://suite.opengeo.org/docs/geoserver/security/tutorials/digest/index.html</span>

<span style="color: #268bd2; font-weight: bold;">    # Configure the Digest authentication filter</span>
<span style="color: #268bd2; font-weight: bold;">    # </span>
<span style="color: #268bd2; font-weight: bold;">    # Start GeoServer and login to the web admin interface as the admin user.</span>
<span style="color: #268bd2; font-weight: bold;">    # Click the Authentication link located under the Security section of the navigation sidebar.</span>
<span style="color: #268bd2; font-weight: bold;">    # Scroll down to the Authentication Filters panel and click the Add new link.</span>
<span style="color: #268bd2; font-weight: bold;">    # Click the Digest link.</span>
<span style="color: #268bd2; font-weight: bold;">    # Fill in the fields of the settings form as follows:</span>
<span style="color: #268bd2; font-weight: bold;">    # Set Name to &#8220;digest&#8221;</span>
<span style="color: #268bd2; font-weight: bold;">    # Set User group service to &#8220;default&#8221;</span>
<span style="color: #268bd2; font-weight: bold;">    # Save.</span>
<span style="color: #268bd2; font-weight: bold;">    # Back on the authentication page scroll down to the Filter Chains panel.</span>
<span style="color: #268bd2; font-weight: bold;">    # Select &#8220;Default&#8221; from the Request type drop down.</span>
<span style="color: #268bd2; font-weight: bold;">    # Unselect the basic filter and select the digest filter. Position the the digest filter before the anonymous filter.</span>
<span style="color: #268bd2; font-weight: bold;">    # Save</span>
<span style="color: #268bd2; font-weight: bold;">    # </span>
<span style="color: #268bd2; font-weight: bold;">    # now go to users, groups, roles</span>
<span style="color: #268bd2; font-weight: bold;">    # under User Group Services, click default</span>
<span style="color: #268bd2; font-weight: bold;">    # under Password encryption, change to digest</span>
<span style="color: #268bd2; font-weight: bold;">    # save</span>
</pre>



</li>
</ul>
<ul>
<li id="sec-4-1-1-3">Secure tomcat<br/>
<ul>
<li>We have a service called Nessus that reviewed the VM tomcat port 
</li>
<li>found some minor issues
</li>
</ul>

<ul>
<li id="sec-4-1-1-3-1">Apache Tomcat servlet/JSP container default files<br/>
Synopsis
The remote web server contains example files.
Description
Example JSPs and Servlets are installed in the remote Apache Tomcat servlet/JSP container. These files should be
removed as they may help an attacker uncover information about the remote Tomcat install or host itself. Or they may
themselves contain vulnerabilities such as cross-site scripting issues.
Solution
Review the files and delete those that are not needed.
Risk Factor
Medium
CVSS Base Score
6.8 (CVSS2#AV:N/AC:M/Au:N/C:P/I:P/A:P)
Plugin Information:
Publication date: 2004/03/02, Modification date: 2012/01/20
Ports
tcp/8081

<p> 
The following default files were found :
</p>
<p> 
 /examples/servlets/index.html
 /examples/jsp/snp/snoop.jsp
 /examples/jsp/index.html
</p>
<p>
Just remove this dir?
cd <i>usr/share/apache-tomcat-6.0.37/webapps rm -R -f examples</i>
</p>
</li>
</ul>
<ul>
<li id="sec-4-1-1-3-2">CGI Generic Cross-Site Scripting (persistent, 3rd Pass)<br/>
A CGI application hosted on the remote web server is potentially prone to cross-site scripting attacks.
Description
The remote web server hosts one or more CGI scripts that fail to adequately sanitize request strings containing
malicious JavaScript. By leveraging this issue, an attacker may be able to cause arbitrary HTML and script code to be
executed in a user's browser within the security context of the affected site.
This script identified patterns that were injected to test 'reflected'
(aka 'non-persistent') XSS. The issues are likely to be 'persistent' (or 'stored') after all
Solution
Restrict access to the vulnerable application and contact the vendor for a patch or upgrade


</li>
</ul>
</li>
</ul>
</div>
</div>

</div>

<div id="outline-container-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Postgres standalone</h3>
<div class="outline-text-3" id="text-4-2">


</div>

<div id="outline-container-4-2-1" class="outline-4">
<h4 id="sec-4-2-1"><span class="section-number-4">4.2.1</span> PostgreSQL /postgresql.html</h4>
<div class="outline-text-4" id="text-4-2-1">






<pre class="src src-markdown"><span style="color: #268bd2; font-weight: bold;">##</span> <span style="color: #268bd2; font-size: 140%; font-weight: bold;">Install PostgreSQL 9.2</span> 
PostgreSQL is an Open Source database that can be extended with GIS functionality using the PostGIS tools.  The latest version is 9.2.  Please see <span style="color: #859900; font-weight: bold;">[this link]</span><span style="color: #2aa198;">(http://people.planetpostgresql.org/devrim/index.php?/archives/70-How-to-install-PostgreSQL-9.2-on-RHELCentOSScientific-Linux-5-and-6.html)</span>  for the orginial documentation I used to install this on Centos or Redhat 6.4.  Check the correct download from <span style="color: #859900; font-weight: bold;">[this link]</span><span style="color: #2aa198;">(http://yum.postgresql.org/repopackages.php#pg92)</span>. Please note that this didn't work on Ubuntu 12.04 LTS for me in early 2013 because PostGIS 2.0 was not included in their repositories.  I ended up rolling back to PostgreSQL 9.1 on that machine.

</pre>



<pre class="src src-markdown"><span style="color: #268bd2; font-weight: bold;">####</span> <span style="color: #268bd2; font-size: 130%; font-weight: bold;">Code</span>
<span style="color: #268bd2; font-weight: bold;">    # install the PostgreSQL 9.2 repo package</span>
<span style="color: #268bd2; font-weight: bold;">    rpm -ivh http://yum.postgresql.org/9.2/redhat/rhel-6-x86_64/pgdg-centos92-9.2-6.noarch.rpm</span>
<span style="color: #268bd2; font-weight: bold;">    # install PostgreSQL 9.2 with single command:</span>
<span style="color: #268bd2; font-weight: bold;">    yum groupinstall "PostgreSQL Database Server PGDG"</span>
<span style="color: #268bd2; font-weight: bold;">    # This will install PostgreSQL 9.2 server, along with -contrib subpackage.</span>
<span style="color: #268bd2; font-weight: bold;">    # Once it is installed, first initialize the cluster:</span>
<span style="color: #268bd2; font-weight: bold;">    service postgresql-9.2 initdb</span>
<span style="color: #268bd2; font-weight: bold;">    # Now, you can start PostgreSQL 9.2:</span>
<span style="color: #268bd2; font-weight: bold;">    service postgresql-9.2 start</span>
<span style="color: #268bd2; font-weight: bold;">    # If you want PostgreSQL 9.2 to start everytime on boot, run this:</span>
<span style="color: #268bd2; font-weight: bold;">    chkconfig postgresql-9.2 on</span>
</pre>




<ul>
<li id="sec-4-2-1-1">Configure PostgreSQL connection settings<br/>



<pre class="src src-markdown"><span style="color: #268bd2; font-weight: bold;">####</span> <span style="color: #268bd2; font-size: 130%; font-weight: bold;">Code</span>
<span style="color: #268bd2; font-weight: bold;">    #edit your pg_hba.conf file under /var/lib/pgsql/9.2/data</span>
<span style="color: #268bd2; font-weight: bold;">    #I added a super user from my ip address and allowed all the local ip addresses access</span>
<span style="color: #268bd2; font-weight: bold;">    host    all             postgres        my.desk.ip.address/32       md5</span>
<span style="color: #268bd2; font-weight: bold;">    # if you want to allow data sharing on a specific database then create a public user</span>
<span style="color: #268bd2; font-weight: bold;">    # host    dbname        publicdata      0.0.0.0/0                   md5</span>
<span style="color: #268bd2; font-weight: bold;">    # if you want people to access from a subnet at your work</span>
<span style="color: #268bd2; font-weight: bold;">    # host    dbname        username        ip.address.range.0/24        md5</span>
</pre>



<pre class="src src-markdown"><span style="color: #268bd2; font-weight: bold;">####</span> <span style="color: #268bd2; font-size: 130%; font-weight: bold;">Code</span>
<span style="color: #268bd2; font-weight: bold;">    #connect to psql</span>
<span style="color: #268bd2; font-weight: bold;">    #Set postgres Password</span>
<span style="color: #268bd2; font-weight: bold;">    su - postgres</span>
<span style="color: #268bd2; font-weight: bold;">    psql postgres postgres</span>
<span style="color: #268bd2; font-weight: bold;">    alter user postgres with password 'password';</span>
<span style="color: #268bd2; font-weight: bold;">    select pg_reload_conf();</span>
<span style="color: #268bd2; font-weight: bold;">    # close the psql using \q</span>
<span style="color: #268bd2; font-weight: bold;">    # change back to root</span>
<span style="color: #268bd2; font-weight: bold;">    exit</span>
</pre>



<pre class="src src-markdown">Now make the server listen for any connection requests from anywhere in the world.
</pre>



<pre class="src src-markdown"><span style="color: #268bd2; font-weight: bold;">####</span> <span style="color: #268bd2; font-size: 130%; font-weight: bold;">Code</span>
<span style="color: #268bd2; font-weight: bold;">    # First locate the postgresql.conf file under /var/lib/pgsql/9.2/data.</span>
<span style="color: #268bd2; font-weight: bold;">    # uncomment and change from localhost</span>
<span style="color: #268bd2; font-weight: bold;">    # listen_addresses = '*'</span>
<span style="color: #268bd2; font-weight: bold;">    # then restart the server</span>
<span style="color: #268bd2; font-weight: bold;">    sudo service postgresql-9.2 restart</span>
<span style="color: #268bd2; font-weight: bold;">    #then reboot and confirm postgres started</span>
</pre>

</li>
</ul>
<ul>
<li id="sec-4-2-1-2">Allow connection to postgres through the firewall<br/>




<pre class="src src-sh"><span style="color: #586e75;">#### </span><span style="color: #586e75;">Code: setting-ports</span>
    vi /etc/sysconfig/iptables 
    <span style="color: #586e75;"># </span><span style="color: #586e75;">and add the line</span>
    -A INPUT -m state --state NEW -m tcp -p tcp --dport 5432 -j ACCEPT
    service iptables restart
</pre>


</li>
</ul>
</div>

</div>

<div id="outline-container-4-2-2" class="outline-4">
<h4 id="sec-4-2-2"><span class="section-number-4">4.2.2</span> PostGIS 2.0 /postgis.html</h4>
<div class="outline-text-4" id="text-4-2-2">

<ul>
<li id="sec-4-2-2-1">Postgis<br/>



<pre class="src src-markdown"><span style="color: #268bd2; font-weight: bold;">--- </span>
<span style="color: #268bd2;">name</span>: <span style="color: #2aa198;">postgis</span>
<span style="color: #268bd2;">layout</span>: <span style="color: #2aa198;">default</span>
<span style="color: #268bd2; font-size: 140%; font-weight: bold;">title: PostGIS</span>
<span style="color: #268bd2; font-weight: bold;">---</span>

&lt;li&gt;&lt;a href="/postgresql.html"&gt;Previous: PostgreSQL&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="/postgres-migrate.html"&gt;Next: PostgreSQL Migrate&lt;/a&gt;&lt;/li&gt;


<span style="color: #268bd2; font-weight: bold;">##</span> <span style="color: #268bd2; font-size: 140%; font-weight: bold;">Install PostGIS 2.0</span>
The PostGIS suite enables a PostgreSQL database with spatial data types and analysis functions.

</pre>



<pre class="src src-markdown"><span style="color: #268bd2; font-weight: bold;">####</span> <span style="color: #268bd2; font-size: 130%; font-weight: bold;">References</span> <span style="color: #268bd2; font-weight: bold; text-decoration: underline;">  </span>
 <span style="color: #859900; font-weight: bold;">[http://www.davidghedini.com/pg/entry/postgis_2_0_on_centos]</span><span style="color: #2aa198;">([http://www.davidghedini.com/pg/entry/postgis_2_0_on_centos])</span>
    <span style="color: #859900; font-weight: bold;">[http://people.planetpostgresql.org/devrim/index.php?/archives/64-PostGIS-2.0.0,-RPMs-and-so..html]</span><span style="color: #2aa198;">(http://people.planetpostgresql.org/devrim/index.php?/archives/64-PostGIS-2.0.0,-RPMs-and-so..html)</span>
    <span style="color: #859900; font-weight: bold;">[http://people.planetpostgresql.org/devrim/index.php?/archives/65-Installing-PostGIS-2.0.X-on-RHELCentOSScientific-Linux-5-and-6-Fedora-That-is-easy!.html]</span><span style="color: #2aa198;">(http://people.planetpostgresql.org/devrim/index.php?/archives/65-Installing-PostGIS-2.0.X-on-RHELCentOSScientific-Linux-5-and-6-Fedora-That-is-easy!.html)</span>
</pre>



<pre class="src src-sh"><span style="color: #586e75;">#### </span><span style="color: #586e75;">code: install-postgis2</span>
    yum list postgis*
    yum install postgis2_92.x86_64 
    yum install postgis2_92-devel.x86_64
  
  
</pre>



</li>
</ul>
<ul>
<li id="sec-4-2-2-2">GDAL, PROJ and GEOS<br/>



<pre class="src src-sh"><span style="color: #586e75;">#### </span><span style="color: #586e75;">Code</span>
    sudo rpm -Uvh http://elgis.argeo.org/repos/6/elgis/x86_64/elgis-release-6-6_0.noarch.rpm
    sudo rpm -Uvh http://mirror.as24220.net/pub/epel/6/i386/epel-release-6-7.noarch.rpm
    <span style="color: #586e75;"># </span><span style="color: #586e75;">yum list gdal*</span>
    yum install gdal-devel.x86_64 
    yum install proj-devel.x86_64
    yum install proj-nad.x86_64
    yum install proj-epsg.x86_64 
    yum install geos-devel.x86_64
    <span style="color: #586e75;">#</span><span style="color: #586e75;">to update</span>
    yum remove gdal*
    yum install gdal-devel.x86_64 
</pre>


</li>
</ul>
<ul>
<li id="sec-4-2-2-3">Create Database<br/>



<pre class="src src-sh"><span style="color: #586e75;">#### </span><span style="color: #586e75;">Code: Create Database</span>
    su - postgres 
    createdb mydb
    psql -d mydb -U postgres  
    CREATE EXTENSION postgis;  
    CREATE EXTENSION postgis_topology;  
 
</pre>



</li>
</ul>
<ul>
<li id="sec-4-2-2-4">Create a GIS user and a group<br/>



<pre class="src src-sh"><span style="color: #586e75;">#### </span><span style="color: #586e75;">Code: Create a GIS user and a group</span>
    CREATE ROLE public_group;
    CREATE ROLE ivan_hanigan LOGIN PASSWORD <span style="color: #2aa198;">'password'</span>;
    GRANT public_group TO ivan_hanigan;

    grant usage on schema public to public_group;
    GRANT select ON ALL TABLES IN SCHEMA public TO public_group;
    grant execute on all functions<span style="color: #859900; font-weight: bold;"> in</span> schema public to public_group;
    grant select on all sequences<span style="color: #859900; font-weight: bold;"> in</span> schema public to public_group;
    grant select on table geometry_columns to public_group;
    grant select on table spatial_ref_sys to public_group;
    grant select on table geography_columns to public_group;
    grant select on table raster_columns to public_group;
    grant select on table raster_overviews to public_group;
    \q
    <span style="color: #859900; font-weight: bold;">exit</span>
</pre>


</li>
</ul>
<ul>
<li id="sec-4-2-2-5">Specific transformations grid for Australian projections AGD66 to GDA94<br/>



<pre class="src src-sh"><span style="color: #586e75;">#### </span><span style="color: #586e75;">Additional Reprojection File</span>
A special transformations grid file is required to be added to the PROJ.4 files for reprojecting the Australian projections AGD66 to GDA94.

Thanks to [Joe Guillaume](https://github.com/josephguillaume) and [Francis Markham](http://stackoverflow.com/users/103225/fmark) <span style="color: #859900; font-weight: bold;">for</span> providing this solution.
</pre>



<pre class="src src-sh"><span style="color: #586e75;">#### </span><span style="color: #586e75;">Code: transformations grid for Australian projections</span>
    <span style="color: #839496; font-weight: bold;">cd</span> /usr/share/proj
    <span style="color: #586e75;"># </span><span style="color: #586e75;">the original was moved</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">wget http://www.icsm.gov.au/icsm/gda/gdatm/national66.zip</span>
    wget http://www.icsm.gov.au/gda/gdatm/national66.zip
    <span style="color: #586e75;"># </span><span style="color: #586e75;">if it moves again a version of it is included with this repo</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">from your local scp to your server</span>
     
    yum install unzip
    unzip national66.zip
    mv <span style="color: #2aa198;">"A66 National (13.09.01).gsb"</span> aust_national_agd66_13.09.01.gsb

    su - postgres 
    psql -d mydb

    UPDATE spatial_ref_sys SET
    <span style="color: #268bd2;">proj4text</span>=<span style="color: #2aa198;">'+proj=longlat +ellps=aust_SA +nadgrids=aust_national_agd66_13.09.01.gsb +wktext'</span>
    where <span style="color: #268bd2;">srid</span>=4202;
    \q
    <span style="color: #859900; font-weight: bold;">exit</span>
</pre>


</li>
</ul>
<ul>
<li id="sec-4-2-2-6">Test transform<br/>



<pre class="src src-sh"><span style="color: #586e75;">#### </span><span style="color: #586e75;">Code: test transformation from AGD66 to GDA94</span>
    <span style="color: #859900; font-weight: bold;">select</span> geocode, geoname, st_transform(geom, 4283) as the_geom
    into schema.gda94_table
    from  schema.agd66_table;
</pre>



<pre class="src src-R"><span style="color: #586e75;">#### </span><span style="color: #586e75;">FROM YOUR R SERVER OR LOCAL ####</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">R</span>
<span style="color: #268bd2; font-weight: bold;">require</span>(devtools)
install_github(<span style="color: #2aa198;">"swishdbtools"</span>, <span style="color: #2aa198;">"swish-climate-impact-assessment"</span>)
<span style="color: #268bd2; font-weight: bold;">require</span>(swishdbtools)
pwd <span style="color: #268bd2; font-weight: bold;">&lt;-</span> getPassword(remote=F)
ch <span style="color: #268bd2; font-weight: bold;">&lt;-</span> connect2postgres2(<span style="color: #2aa198;">"django"</span>)
<span style="color: #586e75;">#</span><span style="color: #586e75;">("ip.address", "dbname", "postgres", p = pwd)</span>
<span style="color: #586e75;">## </span><span style="color: #586e75;">dbSendQuery(su,</span>
<span style="color: #586e75;">## </span><span style="color: #586e75;">"UPDATE spatial_ref_sys SET</span>
<span style="color: #586e75;">## </span><span style="color: #586e75;">proj4text='+proj=longlat +ellps=aust_SA +nadgrids=aust_national_agd66_13.09.01.gsb +wktext'</span>
<span style="color: #586e75;">## </span><span style="color: #586e75;">where srid=4202;</span>
<span style="color: #586e75;">## </span><span style="color: #586e75;">")</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">now you can go ahead and convert AGD66 (4202) to GDA94 (4283)</span>
sql <span style="color: #268bd2; font-weight: bold;">&lt;-</span> sql_subset_into(ch, <span style="color: #2aa198;">"schema.agd66_table"</span>, select =
           <span style="color: #2aa198;">'geocode, geoname, st_transform(geom, 4283) as the_geom'</span>,
           into_schema = <span style="color: #2aa198;">"schema"</span>, into_table = <span style="color: #2aa198;">"gda94_table"</span>, eval = F, check = F)
cat(sql)

</pre>




</li>
</ul>
</div>

</div>

<div id="outline-container-4-2-3" class="outline-4">
<h4 id="sec-4-2-3"><span class="section-number-4">4.2.3</span> PostgreSQL Migration /postgres-migrate.html</h4>
<div class="outline-text-4" id="text-4-2-3">

<ul>
<li id="sec-4-2-3-1">Migrate the data<br/>



<pre class="src src-markdown"><span style="color: #268bd2; font-weight: bold;">---</span>
<span style="color: #268bd2;">name</span>: <span style="color: #2aa198;">postgres-migrate</span>
<span style="color: #268bd2;">layout</span>: <span style="color: #2aa198;">default</span>
<span style="color: #268bd2; font-size: 140%; font-weight: bold;">title: PostgreSQL migration from default location</span>
<span style="color: #268bd2; font-weight: bold;">---</span>

&lt;li&gt;&lt;a href="/postgis.html"&gt;Previous: PostGIS&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="/sharedmemory.html"&gt;Next: Important shared memory settings&lt;/a&gt;&lt;/li&gt;

To take advantage of the extra storage on the secondary disk we mounted in the initial configuration then do the following.
</pre>



<pre class="src src-sh"><span style="color: #586e75;">#### </span><span style="color: #586e75;">Code: Migrate PostgreSQL Data</span>
    service postgresql-9.2 stop
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">Copy the pgsql directory from /var/lib (or customer install directory) location to another location</span>
    cp -r /var/lib/pgsql /home/pgsql
    chown -R postgres:postgres /home/pgsql

    <span style="color: #586e75;">#     </span><span style="color: #586e75;">Edit the start script 'postgresql'</span>
    vi /etc/init.d/postgresql-9.2
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">Search for parameter PGDATA which would be entered as "PGDATA=/var/lib/pgsql"</span>
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">Edit the line such that PGDATA points to the new location. For e.g. "PGDATA=/newloc/pgsql"</span>
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">ALSO DO PGLOG, and PGUPLOG</span>
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">Save and exit the file</span>
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">Start PostgreSQL Service </span>
    service postgresql-9.2 start
    <span style="color: #586e75;"># </span><span style="color: #586e75;">tidy up but not too much, just data?</span>
    rm -r -f /var/lib/pgsql/9.2/data?

</pre>


</li>
</ul>
<ul>
<li id="sec-4-2-3-2">Set up backups<br/>
From here to a secure location at my work.


</li>
</ul>
</div>
</div>

</div>

<div id="outline-container-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> Tuning Postgres Performance</h3>
<div class="outline-text-3" id="text-4-3">


</div>

<div id="outline-container-4-3-1" class="outline-4">
<h4 id="sec-4-3-1"><span class="section-number-4">4.3.1</span> Important shared memory settings /sharedmemory.html</h4>
<div class="outline-text-4" id="text-4-3-1">





<pre class="src src-markdown"><span style="color: #268bd2; font-weight: bold;">--- </span>
<span style="color: #268bd2;">name</span>: <span style="color: #2aa198;">sharedmemory</span>
<span style="color: #268bd2;">layout</span>: <span style="color: #2aa198;">default</span>
<span style="color: #268bd2; font-size: 140%; font-weight: bold;">title: Important Shared Memory Settings</span>
<span style="color: #268bd2; font-weight: bold;">---</span>

<span style="color: #268bd2; font-weight: bold;">##</span> <span style="color: #268bd2; font-size: 140%; font-weight: bold;">Managing memory settings</span>
The default settings in PostgreSQL are usually pretty good but these memory settings are conservative to start with and often need modifications.

<span style="color: #268bd2; font-weight: bold;">##</span> <span style="color: #268bd2; font-size: 140%; font-weight: bold;">References</span>

<span style="color: #859900; font-weight: bold;">[Kernal memory limitations]</span><span style="color: #2aa198;">(http://michael.otacoo.com/postgresql-2/take-care-of-kernel-memory-limitation-for-postgresql-shared-buffers/)</span>

</pre>



<pre class="src src-sh"><span style="color: #586e75;">#### </span><span style="color: #586e75;">Code: sharedmemory</span>
    vi /home/pgsql/9.2/data/postgresql.conf 
    <span style="color: #586e75;"># </span><span style="color: #586e75;">shared_buffers</span>
    
    <span style="color: #586e75;"># </span><span style="color: #586e75;">PostgreSQL has a default shared_buffers value at 32MB, what is</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">enough for small configurations but it is said that this</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">parameter should be set at 25% of the system&#8217;s RAM. This allows</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">your system to keep a good performance in parallel with the</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">database server.  So in the case of a machine with 4GB of RAM,</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">you should set shared_buffers at 1GB.</span>
    2GB = 2048MB
     
    <span style="color: #586e75;">#</span><span style="color: #586e75;">also look at max_locks_per_transaction.  tried setting to 1000???</span>
     
    <span style="color: #586e75;">################################################################</span>
     
    <span style="color: #586e75;"># </span><span style="color: #586e75;">http://www.postgresql.org/docs/9.2/static/kernel-resources.html</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">Linux</span>
     
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">The default maximum segment size is 32 MB, which is only</span>
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">adequate for very small PostgreSQL installations. The</span>
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">default maximum total size is 2097152 pages. A page is</span>
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">almost always 4096 bytes except in unusual kernel</span>
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">configurations with "huge pages" (use getconf PAGE_SIZE to</span>
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">verify). That makes a default limit of 8 GB, which is often</span>
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">enough, but not always.</span>
     
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">The shared memory size settings can be changed via the</span>
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">sysctl interface. For example, to allow 16 GB:</span>
     
    sysctl -w kernel.shmmax=17179869184
    sysctl -w kernel.shmall=4194304
     
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">In addition these settings can be preserved between reboots</span>
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">in the file /etc/sysctl.conf. Doing that is highly</span>
    <span style="color: #586e75;">#     </span><span style="color: #586e75;">recommended.</span>
     
     
    <span style="color: #586e75;">#    </span><span style="color: #586e75;">The remaining defaults are quite generously sized, and</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">usually do not require changes.  also</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">http://www.linux.com/learn/tutorials/394523-configuring-postgresql-for-pretty-good-performance</span>
    <span style="color: #586e75;"># </span><span style="color: #586e75;">work mem 4MB</span>
</pre>


</div>

</div>

<div id="outline-container-4-3-2" class="outline-4">
<h4 id="sec-4-3-2"><span class="section-number-4">4.3.2</span> <span class="todo TODO">TODO</span> Postgres conf</h4>
<div class="outline-text-4" id="text-4-3-2">

<p>I noticed when installing opengeo on RHEL and Ubuntu that the installer changes more parameters on the Ubuntu conf file.  Compare these with diff and update RHEL to reflect the settings for ubuntu.
</p></div>

</div>

<div id="outline-container-4-3-3" class="outline-4">
<h4 id="sec-4-3-3"><span class="section-number-4">4.3.3</span> Test loading some shapefiles</h4>
<div class="outline-text-4" id="text-4-3-3">

<p>on your ubuntu desktop install postgis and gdal (see above)
</p>


<pre class="src src-R"><span style="color: #586e75;">################################################################</span>
sudo apt-get install postgis
</pre>

<p>
then let's demo the Tasmanian SLAs:
</p><ul>
<li id="sec-4-3-3-1">download the shapefiles<br/>



<pre class="src src-R">  <span style="color: #586e75;">################################################################</span>
  <span style="color: #586e75;"># </span><span style="color: #586e75;">name:tassla06</span>
  <span style="color: #586e75;"># </span><span style="color: #586e75;">ABS spatial units are available at http://www.abs.gov.au/AUSSTATS/abs@.nsf/DetailsPage/1259.0.30.0022006?OpenDocument</span>
setwd(<span style="color: #2aa198;">'..'</span>)
dir.create(<span style="color: #2aa198;">'data'</span>)
setwd(<span style="color: #2aa198;">'data'</span>)
dir.create(<span style="color: #2aa198;">'abs_sla'</span>)
setwd(<span style="color: #2aa198;">'abs_sla'</span>)

download.file(<span style="color: #2aa198;">'http://www.abs.gov.au/AUSSTATS/subscriber.nsf/log?openagent&amp;1259030002_sla06aaust_shape.zip&amp;1259.0.30.002&amp;Data%20Cubes&amp;18E90A962EFD4D7ECA25795D00244F5A&amp;0&amp;2006&amp;06.12.2011&amp;Previous'</span>,
                <span style="color: #2aa198;">'SLA06.zip'</span>, mode = <span style="color: #2aa198;">'wb'</span>)
  unzip(<span style="color: #2aa198;">'SLA06.zip'</span>,junkpaths=T)
  
  sink(<span style="color: #2aa198;">'readme.txt'</span>)
    cat(paste(<span style="color: #2aa198;">'Australian Bureau of Statistics Statistical Local Areas 2006</span>
<span style="color: #2aa198;">    downloaded on'</span>, Sys.Date(),
    <span style="color: #2aa198;">'</span>
<span style="color: #2aa198;">    from http://www.abs.gov.au/AUSSTATS/abs@.nsf/DetailsPage/1259.0.30.0022006?OpenDocument'</span>)
    )
  sink()
  
  <span style="color: #586e75;"># </span><span style="color: #586e75;">and load spatial data (sd)</span>
  install.packages(<span style="color: #2aa198;">'rgdal'</span>)
  <span style="color: #268bd2; font-weight: bold;">require</span>(rgdal)
  sd <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readOGR(<span style="color: #2aa198;">'SLA06aAUST.shp'</span>, layer = <span style="color: #2aa198;">'SLA06aAUST'</span>)
  <span style="color: #586e75;"># </span><span style="color: #586e75;">might take a while</span>
  head(sd@data)
  plot(sd)
  dev.off()
  save.image(<span style="color: #2aa198;">'aussd.Rdata'</span>)
  
  <span style="color: #586e75;">######################</span>
  <span style="color: #586e75;"># </span><span style="color: #586e75;">tas</span>
  sd2 <span style="color: #268bd2; font-weight: bold;">&lt;-</span>  sd[ sd@data$STATE_CODE == 6,]
   plot(sd2)
   axis(1);axis(2); box()
  <span style="color: #586e75;"># </span><span style="color: #586e75;">plot(sd, add = T)</span>
   names(sd2@data)
   writeOGR(sd2,<span style="color: #2aa198;">'tassla06.shp'</span>,<span style="color: #2aa198;">'tassla06'</span>,<span style="color: #2aa198;">'ESRI Shapefile'</span>)
   test <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readOGR(dsn = <span style="color: #2aa198;">'tassla06.shp'</span>, layer = <span style="color: #2aa198;">'tassla06'</span>)
   plot(test, col = <span style="color: #2aa198;">'grey'</span>)
   rm(sd)
  <span style="color: #586e75;"># </span><span style="color: #586e75;">save.image('tassd.Rdata')</span>
  
</pre>


</li>
</ul>
<ul>
<li id="sec-4-3-3-2">upload the shp2psql<br/>



<pre class="src src-sh"><span style="color: #586e75;"># </span><span style="color: #586e75;">psql -d ewedb -U postgres -h 115.146.94.209</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">CREATE SCHEMA abs_sla;</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">grant ALL on schema abs_sla to gislibrary;</span>
<span style="color: #839496; font-weight: bold;">cd</span> data
shp2pgsql -s 4283 -D tassla06.shp public.tassla06 &gt; tassla06.sql
<span style="color: #586e75;"># </span><span style="color: #586e75;">psql -d ewedb -U gislibrary -W -h 115.146.94.209 -f tassla06.sql</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">warning terminal not fully functional?  ran from normal terminal</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">now on the remote server run</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">psql ewedb postgres</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">GRANT select ON ALL TABLES IN SCHEMA public TO gislibrary;</span>
</pre>




</li>
</ul>
</div>
</div>
</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> The Brains</h2>
<div class="outline-text-2" id="text-5">

<p>The Brains is a Statistical Analysis engine (running the R environment) integrated with a metadata registry.
</p>
</div>

<div id="outline-container-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> R Server</h3>
<div class="outline-text-3" id="text-5-1">


</div>

<div id="outline-container-5-1-1" class="outline-4">
<h4 id="sec-5-1-1"><span class="section-number-4">5.1.1</span> R</h4>
<div class="outline-text-4" id="text-5-1-1">




<pre class="src src-sh"><span style="color: #586e75;">#</span><span style="color: #586e75;">rpm -Uvh http://mirror.as24220.net/pub/epel/6/i386/epel-release-6-7.noarch.rpm</span>
rpm -Uvh http://mirror.overthewire.com.au/pub/epel/6/i386/epel-release-6-7.noarch.rpm
yum install R R-devel
</pre>

<p>
#rpm -Uvh #<a href="http://mirror.as24220.net/pub/epel/6/i386/epel-release-6-8.noarch.rpm">http://mirror.as24220.net/pub/epel/6/i386/epel-release-6-8.noarch.rpm</a>
To update R as ‘root’ on your system simply type
</p>


<pre class="src src-R">yum update R
</pre>



</div>

</div>

<div id="outline-container-5-1-2" class="outline-4">
<h4 id="sec-5-1-2"><span class="section-number-4">5.1.2</span> <span class="todo TODO">TODO</span> package management and R updates</h4>
<div class="outline-text-4" id="text-5-1-2">

<p>Kudos2
<a href="http://zvfak.blogspot.com.au/2012/06/updating-r-but-keeping-your-installed.html">http://zvfak.blogspot.com.au/2012/06/updating-r-but-keeping-your-installed.html</a>
The problem is that when you update R you usually need to re-install your libraries or change .libPaths() to point to a location that has your previous libraries.
</p>
<p>
The solution below will work for unix-like operating systems including Mac OS X.
</p>


<pre class="src src-R"><span style="color: #586e75;">###########################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">newnode: packageManagement</span>

<span style="color: #586e75;">#</span><span style="color: #586e75;">First, we need a location to install all our packages from now</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">on. This can be any directory, and location of this directory should</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">be indicated in ~/.Renviron file. Let's create that directory now:</span>

mkdir ~/Rlibs

<span style="color: #586e75;">#</span><span style="color: #586e75;">We created Rlibs directory in our home directory. Now, create the</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">.Renviron file in your home directory and enter the following line</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">and save the .Renviron file:</span>

R_LIBS=~/Rlibs

<span style="color: #586e75;"># </span><span style="color: #586e75;">We can now start R and install any library. The libraries will be</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">installed to ~/Rlibs, and when we update R, R will still look for</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">libraries in ~/Rlibs directory so we don't need to re-install the</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">libraries. However, we will need to update the libraries in ~/Rlibs</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">directory to their most recent versions. All we need to do is to run</span>
update.packages() 
<span style="color: #586e75;"># </span><span style="color: #586e75;">in R console, and the libraries will be updated.</span>
</pre>

</div>

</div>

<div id="outline-container-5-1-3" class="outline-4">
<h4 id="sec-5-1-3"><span class="section-number-4">5.1.3</span> Rstudio</h4>
<div class="outline-text-4" id="text-5-1-3">

<p>check out the RSudio versions at: <a href="http://rstudio.org/download/server">http://rstudio.org/download/server</a>
</p>


<pre class="src src-sh"><span style="color: #586e75;"># </span><span style="color: #586e75;">on RHEL6 ran into dependencies: libcrypto.so.6()(64bit) is needed by rstudio-server-0.96.331-1.x86_64</span>
<span style="color: #586e75;">#       </span><span style="color: #586e75;">libgfortran.so.1()(64bit) is needed by rstudio-server-0.96.331-1.x86_64</span>
<span style="color: #586e75;">#       </span><span style="color: #586e75;">libssl.so.6()(64bit) is needed by rstudio-server-0.96.331-1.x86_64</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">http://www.linuxquestions.org/questions/linux-software-2/need-libcrypto-so-6-64bit-and-libssl-so-6-64bit-for-redhat-6-a-873068/</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">yum list openssl098e*</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">yum install openssl098e.x86_64</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">yum list compat-libgfortran*</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">yum install compat-libgfortran-41.x86_64 </span>
wget http://download2.rstudio.org/rstudio-server-0.97.551-x86_64.rpm
sudo yum install --nogpgcheck rstudio-server-0.97.551-x86_64.rpm
rstudio-server verify-installation
</pre>

</div>

</div>

<div id="outline-container-5-1-4" class="outline-4">
<h4 id="sec-5-1-4"><span class="section-number-4">5.1.4</span> firewall access</h4>
<div class="outline-text-4" id="text-5-1-4">




<pre class="src src-sh"><span style="color: #586e75;"># </span><span style="color: #586e75;">kudos2 http://slinsmeier.wordpress.com/2012/05/19/creating-a-lab-environment-with-rstudio/</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">It is necessary to open the firewall port to allow the browser</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">access to RStudio: edit the </span>
vi /etc/sysconfig/iptables 
<span style="color: #586e75;"># </span><span style="color: #586e75;">file and add the line</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">-A INPUT -m state --state NEW -m tcp -p tcp --dport 8787 -j ACCEPT</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">directly after the opening of the ssh port 22 (or copy that line and change the port 22 to 8787).</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">reminder that you need to have the security group set up on the research cloud to allow tcp from 8787 to 8787 cidr 0.0.0.0/0</span>
service iptables restart
</pre>

<p>
Check that you can log on via port 8787.  Note that this is an unsecure R server and the following steps are required to make this a secure server.  We will need to block port 8787 later on.
</p></div>

</div>

<div id="outline-container-5-1-5" class="outline-4">
<h4 id="sec-5-1-5"><span class="section-number-4">5.1.5</span> SSL/HHTPS and running a proxy server</h4>
<div class="outline-text-4" id="text-5-1-5">





<pre class="src src-sh">sudo yum install httpd.x86_64

<span style="color: #586e75;"># </span><span style="color: #586e75;">run the following interactively</span>
sudo openssl genrsa -out /etc/pki/tls/private/rstudio.ivan.com.key 1024
<span style="color: #586e75;"># </span><span style="color: #586e75;">the next is one line</span>
sudo openssl req -new -key /etc/pki/tls/private/rstudio.ivan.com.key -x509 -out /etc/pki/tls/certs/rstudio.ivan.com.crt -days 365

sudo yum install mod_ssl.x86_64 
</pre>



<pre class="src src-sh"><span style="color: #586e75;">#</span><span style="color: #586e75;">vi /etc/httpd/conf.d/ssl.conf </span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">Change the paths to match where the Key file is stored. </span>
SSLCertificateFile /etc/pki/tls/certs/rstudio.ivan.com.crt
<span style="color: #586e75;"># </span><span style="color: #586e75;">Then set the correct path for the Certificate Key File a few lines below. </span>
SSLCertificateKeyFile /etc/pki/tls/private/rstudio.ivan.com.key

mkdir /etc/httpd/sites

<span style="color: #586e75;"># </span><span style="color: #586e75;">vi /etc/httpd/conf/httpd.conf </span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">and add </span>
Include /etc/httpd/sites/
<span style="color: #586e75;"># </span><span style="color: #586e75;">as the last line.</span>

<span style="color: #586e75;"># </span><span style="color: #586e75;">vi /etc/httpd/sites/rstudio-ivan.com</span>

<span style="color: #586e75;"># </span><span style="color: #586e75;">insert</span>
&lt;VirtualHost *:80&gt;

  ServerName rstudio.ivan.com
  RedirectMatch ^(<span style="color: #839496; font-weight: bold;">.</span>*)$ https://rstudio.ivan.com$<span style="color: #268bd2;">1</span>

&lt;/VirtualHost&gt;
<span style="color: #586e75;"># </span><span style="color: #586e75;">goodo</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">vi /etc/httpd/conf.d/ssl.conf</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">add</span>

  &lt;Proxy *&gt;
    Allow from localhost
  &lt;/Proxy&gt;

  ProxyPass        / http://localhost:8787/
  ProxyPassReverse / http://localhost:8787/


<span style="color: #586e75;"># </span><span style="color: #586e75;">before &lt;/VirtualHost&gt;</span>


/etc/init.d/httpd restart

<span style="color: #586e75;"># </span><span style="color: #586e75;">weird error? ignore?</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">Stopping httpd: [60G[FAILED]</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">Starting httpd: httpd: apr_sockaddr_info_get() failed for i-00002979</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">httpd: Could not reliably determine the server's fully qualified domain name, using 127.0.0.1 for ServerName</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">[60G[  OK  ]</span>

sudo chkconfig httpd on
<span style="color: #586e75;"># </span><span style="color: #586e75;">sudo vi /etc/sysconfig/iptables </span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">to the previously added line for 8787 modify to </span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">-A INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j ACCEPT</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">change the research cloud firewall rules to reflect this change</span>

sudo service iptables restart

<span style="color: #586e75;"># </span><span style="color: #586e75;">sudo vi /etc/rstudio/rserver.conf</span>
 www-address=127.0.0.1


sudo /etc/init.d/rstudio-server restart

<span style="color: #586e75;"># </span><span style="color: #586e75;">now going to https://your.new.ip.address/</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">should ask you to add an exception</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">can also try sudo reboot?</span>
</pre>






</div>

</div>

<div id="outline-container-5-1-6" class="outline-4">
<h4 id="sec-5-1-6"><span class="section-number-4">5.1.6</span> git</h4>
<div class="outline-text-4" id="text-5-1-6">




<pre class="src src-sh">yum install git
<span style="color: #586e75;"># </span><span style="color: #586e75;">restart R studio</span>
</pre>

</div>

</div>

<div id="outline-container-5-1-7" class="outline-4">
<h4 id="sec-5-1-7"><span class="section-number-4">5.1.7</span> ssh for github</h4>
<div class="outline-text-4" id="text-5-1-7">

<ul>
<li>in rstudio
</li>
<li>tools / options / version control
</li>
<li>create rsa key, ok, ok
</li>
<li>view pub key, copy, paste to your github account
</li>
</ul>

</div>

</div>

<div id="outline-container-5-1-8" class="outline-4">
<h4 id="sec-5-1-8"><span class="section-number-4">5.1.8</span> gdal</h4>
<div class="outline-text-4" id="text-5-1-8">




<pre class="src src-sh">sudo rpm -Uvh http://elgis.argeo.org/repos/6/elgis/x86_64/elgis-release-6-6_0.noarch.rpm
<span style="color: #586e75;"># </span><span style="color: #586e75;">yum list gdal*</span>
yum install gdal-devel.x86_64 proj-devel.x86_64
</pre>



</div>

</div>

<div id="outline-container-5-1-9" class="outline-4">
<h4 id="sec-5-1-9"><span class="section-number-4">5.1.9</span> geos</h4>
<div class="outline-text-4" id="text-5-1-9">




<pre class="src src-sh">yum install geos-devel.x86_64
</pre>

</div>

</div>

<div id="outline-container-5-1-10" class="outline-4">
<h4 id="sec-5-1-10"><span class="section-number-4">5.1.10</span> or under ubuntu</h4>
<div class="outline-text-4" id="text-5-1-10">




<pre class="src src-sh">sudo apt-get update
sudo apt-get install libgdal1-dev
sudo apt-get install libproj-dev
<span style="color: #586e75;"># </span><span style="color: #586e75;">OR</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">You need the development packages of GDAL and proj4. Probably easier to</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">install from repository than from source. Try:</span>

<span style="color: #586e75;"># </span><span style="color: #586e75;">sudo apt-get install libgdal1-dev libproj-dev</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">sudo R</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">install.packages("rgdal")</span>

</pre>




</div>

</div>

<div id="outline-container-5-1-11" class="outline-4">
<h4 id="sec-5-1-11"><span class="section-number-4">5.1.11</span> test readOGR</h4>
<div class="outline-text-4" id="text-5-1-11">

<p>NB only possible once the PostGIS install is complete, see below.
</p>


<pre class="src src-R"><span style="color: #586e75;">################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">name:readOGR2</span>

<span style="color: #268bd2;">readOGR2</span> <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #859900; font-weight: bold;">function</span>(hostip=<span style="color: #b58900;">NA</span>,user=<span style="color: #b58900;">NA</span>,db=<span style="color: #b58900;">NA</span>, layer=<span style="color: #b58900;">NA</span>, p = <span style="color: #b58900;">NA</span>) {
 <span style="color: #586e75;"># </span><span style="color: #586e75;">NOTES</span>
 <span style="color: #586e75;"># </span><span style="color: #586e75;">only works on Linux OS</span>
 <span style="color: #586e75;"># </span><span style="color: #586e75;">returns uninformative error due to either bad connection or lack of record in geometry column table.  can check if connection problem using a test connect?</span>
 <span style="color: #586e75;"># </span><span style="color: #586e75;">TODO add a prompt for each connection arg if isna</span>
 <span style="color: #859900; font-weight: bold;">if</span> (!<span style="color: #268bd2; font-weight: bold;">require</span>(rgdal)) install.packages(<span style="color: #2aa198;">'rgdal'</span>, repos=<span style="color: #2aa198;">'http://cran.csiro.au'</span>); <span style="color: #268bd2; font-weight: bold;">require</span>(rgdal)
 <span style="color: #859900; font-weight: bold;">if</span>(is.na(p)){
 pwd=readline(<span style="color: #2aa198;">'enter password (ctrl-L will clear the console after): '</span>)
 } <span style="color: #859900; font-weight: bold;">else</span> {
 pwd <span style="color: #268bd2; font-weight: bold;">&lt;-</span> p
 }
 shp <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readOGR(sprintf(<span style="color: #2aa198;">'PG:host=%s</span>
<span style="color: #2aa198;">                         user=%s</span>
<span style="color: #2aa198;">                         dbname=%s</span>
<span style="color: #2aa198;">                         password=%s</span>
<span style="color: #2aa198;">                         port=5432'</span>,hostip,user,db,pwd),
                         layer=layer)

 <span style="color: #586e75;"># </span><span style="color: #586e75;">clean up</span>
 rm(pwd)
 <span style="color: #859900; font-weight: bold;">return</span>(shp)
 }

tassla06 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readOGR2(hostip=<span style="color: #2aa198;">'115.146.95.82'</span>,user=<span style="color: #2aa198;">'gislibrary'</span>,db=<span style="color: #2aa198;">'ewedb'</span>, layer=<span style="color: #2aa198;">'tassla06'</span>)

                                        <span style="color: #586e75;"># </span><span style="color: #586e75;">func</span>
<span style="color: #859900; font-weight: bold;">if</span> (!<span style="color: #268bd2; font-weight: bold;">require</span>(rgdal)) install.packages(<span style="color: #2aa198;">'rgdal'</span>); <span style="color: #268bd2; font-weight: bold;">require</span>(rgdal)
<span style="color: #859900; font-weight: bold;">if</span>(!<span style="color: #268bd2; font-weight: bold;">require</span>(ggmap)) install.packages(<span style="color: #2aa198;">'ggmap'</span>); <span style="color: #268bd2; font-weight: bold;">require</span>(ggmap)
epsg <span style="color: #268bd2; font-weight: bold;">&lt;-</span> make_EPSG()
<span style="color: #586e75;"># </span><span style="color: #586e75;">load</span>
latlong <span style="color: #268bd2; font-weight: bold;">&lt;-</span> read.table(tc <span style="color: #268bd2; font-weight: bold;">&lt;-</span> textConnection(
  <span style="color: #2aa198;">"ID  POINT_Y   POINT_X</span>
<span style="color: #2aa198;">  1  150.5556 -35.09305</span>
<span style="color: #2aa198;">  2  150.6851 -35.01535</span>
<span style="color: #2aa198;">  3  150.6710 -35.06412</span>
<span style="color: #2aa198;">  4  150.6534 -35.08666</span>
<span style="color: #2aa198;">  "</span>), header = <span style="color: #b58900;">TRUE</span>); close(tc)
<span style="color: #586e75;"># </span><span style="color: #586e75;">do</span>
<span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nrow(latlong)){
  coords <span style="color: #268bd2; font-weight: bold;">&lt;-</span> as.numeric(latlong[i,c(<span style="color: #2aa198;">'POINT_Y'</span>, <span style="color: #2aa198;">'POINT_X'</span>)])
  e <span style="color: #268bd2; font-weight: bold;">&lt;-</span> as.data.frame(cbind(i, t(coords), revgeocode(coords)))
  write.table(e, <span style="color: #2aa198;">"test.csv"</span>, sep = <span style="color: #2aa198;">','</span>, append = i &gt; 1, col.names = i == 1, row.names = F)
}
d <span style="color: #268bd2; font-weight: bold;">&lt;-</span> read.csv(<span style="color: #2aa198;">'test.csv'</span>)
head(d)
<span style="color: #586e75;">## </span><span style="color: #586e75;">Treat data frame as spatial points</span>
pts <span style="color: #268bd2; font-weight: bold;">&lt;-</span> SpatialPointsDataFrame(cbind(d$V2,d$V3),d,
                              proj4string=CRS(epsg$prj4[epsg$code %<span style="color: #859900; font-weight: bold;">in</span>% <span style="color: #2aa198;">'4283'</span>]))
writeOGR(pts, <span style="color: #2aa198;">'test.shp'</span>, <span style="color: #2aa198;">'test'</span>, driver=<span style="color: #2aa198;">'ESRI Shapefile'</span>)

</pre>


</div>

</div>

<div id="outline-container-5-1-12" class="outline-4">
<h4 id="sec-5-1-12"><span class="section-number-4">5.1.12</span> rgraphviz</h4>
<div class="outline-text-4" id="text-5-1-12">





<pre class="src src-sh">wget http://www.graphviz.org/graphviz-rhel.repo
mv graphviz-rhel.repo /etc/yum.repos.d/ 
yum list available <span style="color: #2aa198;">'graphviz*'</span>
yum install <span style="color: #2aa198;">'graphviz*'</span>

<span style="color: #586e75;"># </span><span style="color: #586e75;">as root</span>
R
<span style="color: #839496; font-weight: bold;">source</span>(<span style="color: #2aa198;">'http://bioconductor.org/biocLite.R'</span>)
<span style="color: #268bd2;">biocLite</span>(<span style="color: #2aa198;">"Rgraphviz"</span>)
<span style="color: #268bd2;">q</span>()
</pre>




</div>

</div>

<div id="outline-container-5-1-13" class="outline-4">
<h4 id="sec-5-1-13"><span class="section-number-4">5.1.13</span> test</h4>
<div class="outline-text-4" id="text-5-1-13">




<pre class="src src-R"><span style="color: #586e75;">###########################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">newnode: test-rgraphviz</span>
try newnode_test from
git@github.com:ivanhanigan/disentangle.git
</pre>


</div>

</div>

<div id="outline-container-5-1-14" class="outline-4">
<h4 id="sec-5-1-14"><span class="section-number-4">5.1.14</span> install just the postgres bits required for RPostgreSQL package</h4>
<div class="outline-text-4" id="text-5-1-14">




<pre class="src src-sh"><span style="color: #586e75;">###########################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">newnode: rpostgresql</span>
vi /etc/yum.repos.d/CentOS-Base.repo
<span style="color: #586e75;"># </span><span style="color: #586e75;">append: exclude=postgresql* to [base] and [updates] sections</span>
curl -O http://yum.postgresql.org/9.1/redhat/rhel-6-x86_64/pgdg-centos91-9.1-4.noarch.rpm
rpm -ivh pgdg-centos91-9.1-4.noarch.rpm
<span style="color: #586e75;"># </span><span style="color: #586e75;">kudos2 http://www.davidghedini.com/pg/entry/install_postgresql_9_on_centos</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">Many, if not most, third party software and modules are still be set to look for PoistgreSQL's conf file and data directory under their old (pre-version 9) locations.</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">You can address this, and make life easier for yourself, by creating a few symlinks from the new locations to the old.</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">Symlink 1: Symlink for the binary directory. This is particularly useful as this is the location of the pg_config file</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">view plaincopy to clipboardprint?</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">so install the basic packages for a database</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">install a basic PostgreSQL 9.1 server:</span>
yum install postgresql91-server postgresql91 postgresql91-devel postgresql91-libs postgresql91-contrib
<span style="color: #586e75;"># </span><span style="color: #586e75;">THIS LINE HERE</span>
ln -s /usr/pgsql-9.1/bin/pg_config /usr/bin  
<span style="color: #586e75;"># </span><span style="color: #586e75;">now check</span>
R
<span style="color: #268bd2;">install.packages</span>(<span style="color: #2aa198;">'RPostgreSQL'</span>)
<span style="color: #586e75;"># </span><span style="color: #586e75;">works?</span>

</pre>

</div>

</div>

<div id="outline-container-5-1-15" class="outline-4">
<h4 id="sec-5-1-15"><span class="section-number-4">5.1.15</span> postgis utilities</h4>
<div class="outline-text-4" id="text-5-1-15">




<pre class="src src-sh"><span style="color: #586e75;">################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">name:postgisutils</span>
yum list postgis2*
yum install postgis2_91.x86_64 postgis2_91-devel.x86_64 
<span style="color: #586e75;"># </span><span style="color: #586e75;">try </span>
/usr/pgsql-9.1/bin/raster2pgsql

<span style="color: #586e75;"># </span><span style="color: #586e75;">to use this and psql via CMD line need to add using R</span>
su - user
R
<span style="color: #268bd2;">sink</span>(<span style="color: #2aa198;">'~/.pgpass'</span>)
<span style="color: #268bd2;">cat</span>(<span style="color: #2aa198;">'hostname:port:database:username:password'</span>)
<span style="color: #268bd2;">sink</span>()
<span style="color: #268bd2;">q</span>()
<span style="color: #859900; font-weight: bold;">exit</span>
chmod 0600 /home/user/.pgpass
<span style="color: #586e75;"># </span><span style="color: #586e75;">see http://www.postgresql.org/docs/current/static/libpq-pgpass.html</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">and other methods</span>

</pre>



</div>

</div>

<div id="outline-container-5-1-16" class="outline-4">
<h4 id="sec-5-1-16"><span class="section-number-4">5.1.16</span> <span class="todo TODO">TODO</span> unixODBC</h4>
<div class="outline-text-4" id="text-5-1-16">




<pre class="src src-sh"><span style="color: #586e75;">################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">name:unixODBC</span>
yum list unixODBC*
yum install unixODBC.x86_64  unixODBC-devel.x86_64 unixODBC-kde.x86_64 
R
<span style="color: #268bd2;">install.packages</span>(<span style="color: #2aa198;">'RODBC'</span>)
<span style="color: #268bd2;">require</span>(RODBC)
</pre>


</div>
</div>

</div>

<div id="outline-container-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Test the Backups of this Minimal R Sever.</h3>
<div class="outline-text-3" id="text-5-2">

<p>To test that this will restore successfully if there is a crash or the VM becomes corrupted take a snapshot from the ResearchCloud dashboard website and launch it to a new VM.  Note that this will only restore the 10GB primary disc which has our software but not the user data which is on the secondary disc so try mounting that and check that the new VM will be a good replacement of the old one.
</p>
</div>

<div id="outline-container-5-2-1" class="outline-4">
<h4 id="sec-5-2-1"><span class="section-number-4">5.2.1</span> Backup the 2nd Disc</h4>
<div class="outline-text-4" id="text-5-2-1">




<pre class="src src-sh"><span style="color: #586e75;">################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">name:2ndDisc</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">on your secure local machine</span>
mkdir /projects/OpenSoftware-RestrictedData/Archives
<span style="color: #586e75;"># </span><span style="color: #586e75;">on your remote server</span>

ssh root@ip.address.of.server
<span style="color: #839496; font-weight: bold;">cd</span> /
mkdir backups
<span style="color: #839496; font-weight: bold;">cd</span> backups
zip -r homebackup_yyyymmdd /home
<span style="color: #586e75;">#</span><span style="color: #586e75;">scp homebackup_yyyymmdd.zip root@ip.address.of.server:/Archives</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">or use the R studio download file function</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">upload to the new R server</span>
<span style="color: #859900; font-weight: bold;">exit</span>
scp /Archives/homebackup.zip root@ipaddress:/home
<span style="color: #586e75;"># </span><span style="color: #586e75;">and unzip (TODO need to mv these up to the /home/ level after unzip)</span>
ssh root@ip.address.of.server
<span style="color: #839496; font-weight: bold;">cd</span> home
unzip homebackup.zip
rm homebackup.zip
</pre>




</div>

</div>

<div id="outline-container-5-2-2" class="outline-4">
<h4 id="sec-5-2-2"><span class="section-number-4">5.2.2</span> Launch from this snapshot and test the R server and 2nd Disc</h4>
<div class="outline-text-4" id="text-5-2-2">


</div>

</div>

<div id="outline-container-5-2-3" class="outline-4">
<h4 id="sec-5-2-3"><span class="section-number-4">5.2.3</span> <span class="todo TODO">TODO</span> the permissions of the user on their home directory cause issues for logging in.</h4>
<div class="outline-text-4" id="text-5-2-3">

<p>I've just used userdel -r username, then useradd etc and use their own user account to scp the backup files across.
One solution is to not offer backup services, then users will have to undertake to load all data again from a fresh server if it failed.  Data could be backed up on Brawn only?
</p>
</div>
</div>

</div>

<div id="outline-container-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> Oracle XE Permissions and Users System</h3>
<div class="outline-text-3" id="text-5-3">

<p>Installing Oracle XE, this is used as a data registry and I have a HTML-DB application available from XXXXXX to be used.  It is called OraPUS because the Oracle XE license restricts any references to Oracle in the name of the application.  There are other restrictions on this licence such as XXXXX.
</p>
</div>

<div id="outline-container-5-3-1" class="outline-4">
<h4 id="sec-5-3-1"><span class="section-number-4">5.3.1</span> backup local ubuntu version</h4>
<div class="outline-text-4" id="text-5-3-1">

<p>I have a ubuntu pc as my main desktop and also backups
to create oracle on this I needed a centos virtual Machines
use the instructions at <a href="http://extr3metech.wordpress.com/2012/10/25/centos-6-3-installation-in-virtual-box-with-screenshots/">http://extr3metech.wordpress.com/2012/10/25/centos-6-3-installation-in-virtual-box-with-screenshots/</a>
and also the comments ie:
@Gunwant, One way for configuring the network, open your virtual box settings and go to the “Network” tab and choose the option “Attached to” to “Bridged Adapter”.
</p>
<p>
Then boot your centos virtual machine, and type the following in your terminal:
</p>

<p>
And then change the file to the following:
</p>
<p>
DEVICE=”eth0″
BOOTPROTO=”dhcp”
ONBOOT=”yes
</p>
<p>
And save the file and exit. After that you need to restart the network service and you can do that by typing the following in the terminal:
</p>

<p>
Now, you can check your command
</p>

<p>
Now, it should work. I will be posting a detailed article soon for my readers soon. Thank you for visiting my blog. Feel free to ask any questions in the comments section. Have fun!
</p>



</div>

</div>

<div id="outline-container-5-3-2" class="outline-4">
<h4 id="sec-5-3-2"><span class="section-number-4">5.3.2</span> INIT</h4>
<div class="outline-text-4" id="text-5-3-2">




<pre class="src src-sh"><span style="color: #586e75;">################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">name:init</span>
yum update
<span style="color: #586e75;"># </span><span style="color: #586e75;">SElinux config</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">vi /etc/selinux/config</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">This file controls the state of SELinux on the system.</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">SELINUX= can take one of these three values:</span>
<span style="color: #586e75;">#     </span><span style="color: #586e75;">enforcing - SELinux security policy is enforced.</span>
<span style="color: #586e75;">#     </span><span style="color: #586e75;">permissive - SELinux prints warnings instead of enforcing.</span>
<span style="color: #586e75;">#     </span><span style="color: #586e75;">disabled - No SELinux policy is loaded.</span>
<span style="color: #268bd2;">SELINUX</span>=enforcing
<span style="color: #586e75;"># </span><span style="color: #586e75;">Change SELINUX=enforcing to disabled and you must reboot the server after applying the change.</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">vi /etc/hosts</span>
127.0.0.1  localhost.localdomain localhost ADD-VMNAME 
</pre>

</div>

</div>

<div id="outline-container-5-3-3" class="outline-4">
<h4 id="sec-5-3-3"><span class="section-number-4">5.3.3</span> SWAP</h4>
<div class="outline-text-4" id="text-5-3-3">

<p>MAKE SURE YOU HAVE 2GB SWAP, this is required for install but I have deleted it aftward and things still work
<a href="http://bvirtual.nl/2009/08/add-more-swap-space-to-running-linux.html">http://bvirtual.nl/2009/08/add-more-swap-space-to-running-linux.html</a>
I SET TO 3000, didn't set to start at boot so have to 
swapon /swapfile
</p>


<pre class="src src-sh"><span style="color: #586e75;">################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">name:swap</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">Create an empty file called /swapfile from about 2GB</span>
dd <span style="color: #268bd2;">if</span>=/dev/zero <span style="color: #268bd2;">of</span>=/swapfile <span style="color: #268bd2;">bs</span>=1024000 <span style="color: #268bd2;">count</span>=3000
<span style="color: #586e75;">#</span><span style="color: #586e75;">Format the new file to make it a swap file</span>
mkswap /swapfile
<span style="color: #586e75;">#</span><span style="color: #586e75;">Enable the new swapfile. Only the swapon command is needed, but with</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">the free command you can clearly see the swap space is made available</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">to the system.</span>
free -m | grep Swap
swapon /swapfile
free -m | grep Swap
<span style="color: #586e75;"># </span><span style="color: #586e75;">TOO LAZY TO ADD TO BOOT SO JUST DO SWAPON EVERY TIME?</span>
</pre>


</div>

</div>

<div id="outline-container-5-3-4" class="outline-4">
<h4 id="sec-5-3-4"><span class="section-number-4">5.3.4</span> DOWNLOAD AND SCP</h4>
<div class="outline-text-4" id="text-5-3-4">

<p>create free oracle account.  download to local and then upload to server.
</p>


<pre class="src src-R">scp oracle-xe-11.2.0-1.0.x86_64.rpm.zip user@ip.address.of.server:/home/
</pre>

</div>

</div>

<div id="outline-container-5-3-5" class="outline-4">
<h4 id="sec-5-3-5"><span class="section-number-4">5.3.5</span> Install the database</h4>
<div class="outline-text-4" id="text-5-3-5">

<p>I followed these online guides:
<a href="http://youtu.be/DRZg8tfmldA">http://youtu.be/DRZg8tfmldA</a> (this needs VNC or other)
<a href="http://www.davidghedini.com/pg/entry/install_oracle_11g_xe_on">http://www.davidghedini.com/pg/entry/install_oracle_11g_xe_on</a>
</p>



<pre class="src src-R">yum install libaio bc flex unzip 
cd /home
mkdir OracleXE
unzip oracle-xe-11.2.0-1.0.x86_64.rpm.zip -d OracleXE 
cd OracleXE/Disk1
rpm -ivh oracle-xe-11.2.0-1.0.x86_64.rpm  
/etc/init.d/oracle-xe configure
<span style="color: #586e75;"># </span><span style="color: #586e75;">accept defaults</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">set up the etc/group file so that oracle is in dba (and oinstall? not there?)</span>
id -a oracle
<span style="color: #586e75;">#</span><span style="color: #586e75;">log on as oracle and then </span>
su - oracle
<span style="color: #586e75;"># </span><span style="color: #586e75;">set the environment</span>
cd /u01/app/oracle/product/11.2.0/xe/bin  
. ./oracle_env.sh 
<span style="color: #586e75;"># </span><span style="color: #586e75;">NOT DONE, which users needs this?  which dot file?  both?  To set</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">the environment permanently for users, add the following to the</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">.bashrc or .bash_profile of the users you want to access the</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">environment:</span>
     . /u01/app/oracle/product/11.2.0/xe/bin/oracle_env.sh 
sqlplus /nolog
connect sys/password as sysdba
<span style="color: #586e75;">#</span><span style="color: #586e75;">To allow remote access to Oracle 11g XE GUI (as well as Application Express GUI) issue the following from SQL*Plus</span>
EXEC DBMS_XDB.SETLISTENERLOCALACCESS(<span style="color: #b58900;">FALSE</span>);  
exit
su - root
<span style="color: #586e75;"># </span><span style="color: #586e75;">modify firewall</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">vi /etc/sysconfig/iptables</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">copy -A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">twice and modify for 8080 and 1521</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">restrict 1521 to your administration IP address</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">will also need the port 8080 enabled on the research cloud firewall</span>
service iptables restart
</pre>

<p>
Now we can check the database service is running by pointing a browser at
<a href="http://ip.address.of.server:8080/apex">http://ip.address.of.server:8080/apex</a>
</p>
<p>
Although Apex is already installed, we still need to set the Internal Admin password. 
</p>


<pre class="src src-R"><span style="color: #586e75;"># </span><span style="color: #586e75;">To do so, run the apxchpwd.sql located under /u01/app/oracle/product/11.2.0/xe/apex:</span>
su - oracle
. /u01/app/oracle/product/11.2.0/xe/bin/oracle_env.sh
sqlplus /nolog
connect sys/password as sysdba
@/u01/app/oracle/product/11.2.0/xe/apex/apxchpwd.sql 
<span style="color: #586e75;">#</span><span style="color: #586e75;">Note: pick something simple like Password123! as you will be prompted to change it on first log in anyways.</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">access the Application Express GUI at:</span>
http://ip.address.of.server:8080/apex/f?p=4550:1
</pre>


<p>
Now log on:
</p><ul>
<li>Workspace: Internal
</li>
<li>User Name: admin
</li>
<li>Password: (whatever you selected above).
</li>
<li>log in, change password
</li>
<li>log in again
</li>
</ul>

<p>Now create Workspace:
</p><ul>
<li>Workspace Name = DDIINDEXDB
</li>
<li>next page say existing schema "no" and write DDIINDEXDB into the schema Name
</li>
<li>schema password same as the user you want
</li>
<li>100MB
</li>
<li>admin user IVAN
</li>
</ul>

</div>

</div>

<div id="outline-container-5-3-6" class="outline-4">
<h4 id="sec-5-3-6"><span class="section-number-4">5.3.6</span> import application and set Security</h4>
<div class="outline-text-4" id="text-5-3-6">

<p>import the application 102
then set authentication 
I followed the advice from the oracle documentation <a href="http://docs.oracle.com/cd/E17556_01/doc/user.40/e15517/sec.htm#BCGICEAH">http://docs.oracle.com/cd/E17556_01/doc/user.40/e15517/sec.htm#BCGICEAH</a>
Changing the Authentication Scheme Associated with an Application.
To change the authentication scheme for an application:
</p>
<p>
Navigate to the Authentication Schemes:
</p><ul>
<li>On the Workspace home page, click the Application Builder icon.
</li>
<li>Select an application.
</li>
<li>On the Application home page, click Shared Components.
</li>
<li>The Shared Components page appears.
</li>
<li>Under Security, select Authentication Schemes.
</li>
<li>Click the Change Current tab at the top of the page.
</li>
<li>From Available Authentication Schemes, select a new authentication scheme and  click Next.
</li>
<li>(Application Express is good)
</li>
<li>Click Make Current.
</li>
</ul>




</div>

</div>

<div id="outline-container-5-3-7" class="outline-4">
<h4 id="sec-5-3-7"><span class="section-number-4">5.3.7</span> <span class="todo TODO">TODO</span> explain the table creation script</h4>
<div class="outline-text-4" id="text-5-3-7">

<p>now go to lib/setup<sub>oracle</sub><sub>of</sub><sub>delphe</sub>.r
to build the tables
</p></div>

</div>

<div id="outline-container-5-3-8" class="outline-4">
<h4 id="sec-5-3-8"><span class="section-number-4">5.3.8</span> set up R, RJDBC and ROracle</h4>
<div class="outline-text-4" id="text-5-3-8">

<p>Using RJDBC is what I recommend.  I found ROracle suboptimal.
</p>




<pre class="src src-R">su root
<span style="color: #586e75;">#</span><span style="color: #586e75;">make sure env is set</span>
export LD_LIBRARY_PATH=/u01/app/oracle/product/11.2.0/xe/lib:$LD_LIBRARY_PATH

R
<span style="color: #268bd2;">connect2oracle</span> <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #859900; font-weight: bold;">function</span>(){
<span style="color: #859900; font-weight: bold;">if</span>(!<span style="color: #268bd2; font-weight: bold;">require</span>(RJDBC)) install.packages(<span style="color: #2aa198;">'RJDBC'</span>); <span style="color: #268bd2; font-weight: bold;">require</span>(RJDBC)
drv <span style="color: #268bd2; font-weight: bold;">&lt;-</span> JDBC(<span style="color: #2aa198;">"oracle.jdbc.driver.OracleDriver"</span>,
            <span style="color: #2aa198;">'/u01/app/oracle/product/11.2.0/xe/jdbc/lib/ojdbc6.jar'</span>)
p <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readline(<span style="color: #2aa198;">'enter password: '</span>)
h <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readline(<span style="color: #2aa198;">'enter target ipaddres: '</span>)
d <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readline(<span style="color: #2aa198;">'enter database name: '</span>)
ch <span style="color: #268bd2; font-weight: bold;">&lt;-</span> dbConnect(drv,paste(<span style="color: #2aa198;">"jdbc:oracle:thin:@"</span>,h,<span style="color: #2aa198;">":1521"</span>,sep=<span style="color: #2aa198;">''</span>),d,p)
<span style="color: #859900; font-weight: bold;">return</span>(ch)
}  
ch <span style="color: #268bd2; font-weight: bold;">&lt;-</span> connect2oracle()


<span style="color: #586e75;"># </span><span style="color: #586e75;">OR</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">install.packages('ROracle')</span>
</pre>


</div>

</div>

<div id="outline-container-5-3-9" class="outline-4">
<h4 id="sec-5-3-9"><span class="section-number-4">5.3.9</span> <span class="todo TODO">TODO</span> maintenance</h4>
<div class="outline-text-4" id="text-5-3-9">

</div>
</div>

</div>

<div id="outline-container-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> unlock</h3>
<div class="outline-text-3" id="text-5-4">


</div>

<div id="outline-container-5-4-1" class="outline-4">
<h4 id="sec-5-4-1"><span class="section-number-4">5.4.1</span> unlock header</h4>
<div class="outline-text-4" id="text-5-4-1">




</div>
</div>

</div>

<div id="outline-container-5-5" class="outline-3">
<h3 id="sec-5-5"><span class="section-number-3">5.5</span> DDIindex</h3>
<div class="outline-text-3" id="text-5-5">

<p>The DDIindex is a java based catalogue that was written by the Australian Data Archives at the ANU (Formerly the ASSDA <a href="http://assda.anu.edu.au/ddiindex.html">http://assda.anu.edu.au/ddiindex.html</a>). The original application source is still available from the ASSDA site but I am using the one I have archived because it has some configurations that I don't remember who to make again at the moment.
</p>
</div>

<div id="outline-container-5-5-1" class="outline-4">
<h4 id="sec-5-5-1"><span class="section-number-4">5.5.1</span> TOMCAT</h4>
<div class="outline-text-4" id="text-5-5-1">

<p><a href="http://coastalrocket.blogspot.com.au/2012/08/installing-geostack-on-centos-6-64bit.html">http://coastalrocket.blogspot.com.au/2012/08/installing-geostack-on-centos-6-64bit.html</a>
</p>


<pre class="src src-R"><span style="color: #586e75;">###########################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">newnode: install-tomcat</span>
yum -y install tomcat6 tomcat6-webapps
<span style="color: #586e75;"># </span><span style="color: #586e75;">not tomcat6-admin-webapps </span>
vi /etc/tomcat6/tomcat-users.xml
<span style="color: #586e75;">#</span><span style="color: #586e75;">add a user with roles of admin,manager like this</span>
&lt;user name=<span style="color: #2aa198;">"tomcat"</span> password=<span style="color: #2aa198;">"password"</span> roles=<span style="color: #2aa198;">"admin,manager"</span> /&gt;
</pre>



<pre class="src src-sh"><span style="color: #586e75;">###########################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">newnode: for-restarts</span>
chkconfig tomcat6 on
</pre>


<p>
changing the Tomcat Port
</p><ul>
<li>Locate server.xml in {Tomcat installation folder}\ conf \
</li>
<li>change &lt;Connector port="8181"/&gt; from 8080
</li>
<li>and connector executor too?  only if it is not commented out (was on centos, not on RHEL)
</li>
<li>change iptables and restart
</li>
</ul>




<pre class="src src-R">service tomcat6 restart
</pre>




</div>

</div>

<div id="outline-container-5-5-2" class="outline-4">
<h4 id="sec-5-5-2"><span class="section-number-4">5.5.2</span> UPLOAD THE DDIINDEX</h4>
<div class="outline-text-4" id="text-5-5-2">


</div>

</div>

<div id="outline-container-5-5-3" class="outline-4">
<h4 id="sec-5-5-3"><span class="section-number-4">5.5.3</span> MySQL</h4>
<div class="outline-text-4" id="text-5-5-3">

<p><a href="http://www.if-not-true-then-false.com/2010/install-mysql-on-fedora-centos-red-hat-rhel/">http://www.if-not-true-then-false.com/2010/install-mysql-on-fedora-centos-red-hat-rhel/</a>
</p>


<pre class="src src-R">rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-6.rpm
yum --enablerepo=remi,remi-test list mysql mysql-server
yum --enablerepo=remi,remi-test install mysql mysql-server
/etc/init.d/mysqld start <span style="color: #586e75;">## </span><span style="color: #586e75;">use restart after update</span>
<span style="color: #586e75;">## </span><span style="color: #586e75;">OR ##</span>
service mysqld start <span style="color: #586e75;">## </span><span style="color: #586e75;">use restart after update</span>

chkconfig --levels 235 mysqld on

mysqladmin -u root password [your_password_here]
mysql -h localhost -u root -p
then create database, 
database user and
database password 
<span style="color: #586e75;">## </span><span style="color: #586e75;">CREATE DATABASE ##</span>
mysql&gt; CREATE DATABASE security;

<span style="color: #586e75;">## </span><span style="color: #586e75;">CREATE USER ##</span>
mysql&gt; CREATE USER <span style="color: #2aa198;">'ddiindex'</span>@<span style="color: #2aa198;">'localhost'</span> IDENTIFIED BY <span style="color: #2aa198;">'BlahBlahBlah'</span>;

<span style="color: #586e75;">## </span><span style="color: #586e75;">GRANT PERMISSIONS ##</span>
mysql&gt; GRANT ALL ON security.* TO <span style="color: #2aa198;">'ddiindex'</span>@<span style="color: #2aa198;">'localhost'</span>;

<span style="color: #586e75;">##  </span><span style="color: #586e75;">FLUSH PRIVILEGES, Tell the server TO reload the GRANT TABLES  ##</span>
mysql&gt; FLUSH PRIVILEGES;

<span style="color: #586e75;"># </span><span style="color: #586e75;">nd then use next at command line:</span>

mysql -h localhost -u root -p security &lt; security_2010-04-27-1259.sql; 
<span style="color: #586e75;"># </span><span style="color: #586e75;">Enter password: </span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">deprecated let thru iptables port 3306?</span>
</pre>

</div>

</div>

<div id="outline-container-5-5-4" class="outline-4">
<h4 id="sec-5-5-4"><span class="section-number-4">5.5.4</span> make sure ddiindex can connect to mysql as ddiindex user</h4>
<div class="outline-text-4" id="text-5-5-4">




<pre class="src src-sh"><span style="color: #586e75;"># </span><span style="color: #586e75;">now go to /usr/share/tomcat/webapps/ddiindex/WEB-INF/classes/index-conf.xml</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">dburl change to </span>
    &lt;dbUrl&gt;jdbc:mysql://localhost:3306/security&lt;/dbUrl&gt;
    &lt;dbUserName&gt;ddiindex&lt;/dbUserName&gt;
    &lt;dbPassword&gt;BlahBlahBlah&lt;/dbPassword&gt;
<span style="color: #586e75;"># </span><span style="color: #586e75;">other personalisations here such as &lt;dataServer&gt;</span>
mkdir /opt/ddiindex/ewedb
mkdir /opt/ddiindex/ewedb_s

</pre>

<p>
from home.jsp removed
&lt;%@taglib uri="<a href="http://assda.anu.edu.au/ddiindex">http://assda.anu.edu.au/ddiindex</a>" prefix="ddiindex"%&gt;
and login.jsp
&lt;%@taglib uri="<a href="http://assda.anu.edu.au/ddiindex">http://assda.anu.edu.au/ddiindex</a>" prefix="ddiindex"%&gt;
and search.jsp
&lt;%@taglib uri="<a href="http://assda.anu.edu.au/ddiindex">http://assda.anu.edu.au/ddiindex</a>" prefix="ddiindex"%&gt;
</p>
</div>

</div>

<div id="outline-container-5-5-5" class="outline-4">
<h4 id="sec-5-5-5"><span class="section-number-4">5.5.5</span> <span class="todo TODO">TODO</span> Check the security implications of allowing write permissions here</h4>
<div class="outline-text-4" id="text-5-5-5">

<p>I found I need to allow write access to the  xmldata folder for uploads of the xml metadata files.
</p>


<pre class="src src-sh">adduser ddiindex
chown -R ddiindex /xmldata
chmod 0777 /xmldata
<span style="color: #586e75;"># </span><span style="color: #586e75;">bad for security, try 0750 instead</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">chmod 0777 /opt/ddiindex/nceph</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">or this works</span>
chmod -R 777 /opt/ddiindex/nceph
chmod 0777 /opt/ddiindex/nceph_s
chmod -R 777 /opt/ddiindex/ewedb
chmod 0777 /opt/ddiindex/ewedb_s
</pre>



</div>

</div>

<div id="outline-container-5-5-6" class="outline-4">
<h4 id="sec-5-5-6"><span class="section-number-4">5.5.6</span> Running the Indexer</h4>
<div class="outline-text-4" id="text-5-5-6">

<p>Log on as an admin user (set in the MySQL userEJB table) and you can run the indexer.jsp
Before doing this the first time I did the following:
</p><ul>
<li>went to nceph and nceph<sub>s</sub> deleted the recent created files
</li>
<li>went to xmldata, deleted all
</li>
<li>restart TOMCAT
</li>
<li>go to indexer, upload xml
</li>
<li>hit the 'add to index' button.
</li>
</ul>



</div>

</div>

<div id="outline-container-5-5-7" class="outline-4">
<h4 id="sec-5-5-7"><span class="section-number-4">5.5.7</span> personalise the ddiindex</h4>
<div class="outline-text-4" id="text-5-5-7">

<p>ie home.jsp
   &lt;div class="intro"&gt;The Graduate Information Literacy Program at ANU now offers resources for researchers and graduate students on data management planning: a comprehensive Manual and a Data Management Planning Template. &lt;a href="<a href="http://ilp.anu.edu.au/dm/">http://ilp.anu.edu.au/dm/</a>" target="<sub>blank</sub>"&gt;<a href="http://ilp.anu.edu.au/dm">http://ilp.anu.edu.au/dm</a>&lt;/a&gt;&lt;/div&gt;
</p>
</div>
</div>

</div>

<div id="outline-container-5-6" class="outline-3">
<h3 id="sec-5-6"><span class="section-number-3">5.6</span> Set up a private git server for data and code</h3>
<div class="outline-text-3" id="text-5-6">




</div>

</div>

<div id="outline-container-5-7" class="outline-3">
<h3 id="sec-5-7"><span class="section-number-3">5.7</span> True-Crypt encrypted volumes</h3>
<div class="outline-text-3" id="text-5-7">

<p>The servers are secure but we will sometimes want local copies and so should use truecrypt or another option.  I am using Ubuntu as my desktop so here is the instructions.
</p>


<pre class="src src-R"><span style="color: #586e75;">################################################################</span>
<span style="color: #586e75;">#</span><span style="color: #586e75;">http://www.liberiangeek.net/2012/07/install-truecrypt-via-ppa-in-ubuntu-12-04-precise-pangolin/</span>
sudo add-apt-repository ppa:michael-astrapi/ppa
sudo apt-get update &amp;&amp; sudo apt-get install truecrypt

<span style="color: #586e75;">#### </span><span style="color: #586e75;">FAILED TO INSTALL ON REDHAT ####</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">or http://ubuntupop.blogspot.com.au/2012/10/how-to-install-truecrypt-on-centos-63.html</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">1. Download Truecrypt package. Or use wget instead</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">wget http://www.truecrypt.org/download/truecrypt-7.1a-linux-x64.tar.gz</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">2.  Now extract the package</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">tar xzvf truecrypt-7.1a-linux-x64.tar.gz</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">3. It will produce a file called truecrypt-7.1a-setup-x64</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">chmod +x truecrypt-7.1a-setup-x64 </span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">./truecrypt-7.1a-setup-x64</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">installer ran but then </span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">truecrypt -h </span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">truecrypt: error while loading shared libraries: libfuse.so.2: cannot open shared object file: No such file or directory</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">yum install libfuse.so.2 didn't help</span>

<span style="color: #586e75;"># </span><span style="color: #586e75;">DIDN'T TRY  http://vinnn.blogspot.com.au/2009/01/tryecrypt-6-on-centos-5.html</span>
</pre>


</div>

</div>

<div id="outline-container-5-8" class="outline-3">
<h3 id="sec-5-8"><span class="section-number-3">5.8</span> <span class="todo TODO">TODO</span> ResearchData storage</h3>
<div class="outline-text-3" id="text-5-8">




<pre class="src src-R"><span style="color: #586e75;">################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">name:ResearchData</span>
cd /home
mkdir ResearchData
chmod 0777 /home/ResearchData
<span style="color: #586e75;"># </span><span style="color: #586e75;">TODO check the security of this</span>
</pre>



</div>
</div>

</div>

<div id="outline-container-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Procedures for add users to the system.</h2>
<div class="outline-text-2" id="text-6">


</div>

<div id="outline-container-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> Description of the access procedure</h3>
<div class="outline-text-3" id="text-6-1">


</div>

<div id="outline-container-6-1-1" class="outline-4">
<h4 id="sec-6-1-1"><span class="section-number-4">6.1.1</span> Getting Access</h4>
<div class="outline-text-4" id="text-6-1-1">

<p>The "Getting Access" procedure to help users apply for and gain access to mortality data is shown in Figure 1, and a more detailed description of the process is shown in the Appendix, Figure 4. The process is a set of formally defined steps that are designed to move the User through two general stages:
</p><ul>
<li>Requesting data: guiding the researcher through the process of (a) gaining Ethics Approval from a Human Research Ethics Committee, and (b) Project Level Approval from the Registrar of Births, Deaths and Marriages.
</li>
<li>Providing data: provision of a confidentialised (often aggregated) dataset in an appropriately secured manner such as access to remote secure servers or encrypted archives accessed on local disk media, with security determined by (a) the nature of the data and (b) any project management related criteria.
</li>
</ul>






</div>

</div>

<div id="outline-container-6-1-2" class="outline-4">
<h4 id="sec-6-1-2"><span class="section-number-4">6.1.2</span> Managing Access</h4>
<div class="outline-text-4" id="text-6-1-2">

<p>Procedures for managing access are shown in Figure 2 (and in the Appendix, Figure 5). These activities are intended to maintain information on the current state of projects using the mortality data, and to report any changes in situation to the State Registries. The User Administrator is responsible for conduct of the "Managing Access" procedures.
</p>
<p>
The process is initiated by running a query on the ANU-User-DB to make a list of all Projects and Users, and then each Project is sent a reminder to report any changes in Project Status (sent annually to coincide with a similar reminder sent by the ANU Human Research Ethics Committee). The purpose of these reminders is to ensure that Project management plans continue to consider data security as a primary concern, even during long multi-year projects where many project management and staffing issues inevitably arise.
</p>
<p>
Once a response is received, the User Administrator then enters the relevant information into the ANU-User-DB, and if the project has been concluded will then initiate the final "Ending Access" process.
</p></div>

</div>

<div id="outline-container-6-1-3" class="outline-4">
<h4 id="sec-6-1-3"><span class="section-number-4">6.1.3</span> Ending Access</h4>
<div class="outline-text-4" id="text-6-1-3">

<p>The procedure for ending access aims to ensure that data are both securely and sustainably stored.  It is very important that files used for authorised projects are never re-used in un-authorised projects, but that future researchers may have the opportunity to create an authorised project and potentially replicate historical analyses.  This is an important part of reproducible research and the robust practice of scientific enquiry.
</p>
</div>
</div>

</div>

<div id="outline-container-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> The process user administrators go through to set up users</h3>
<div class="outline-text-3" id="text-6-2">

<p>When adding users go to the oraphi and track their permissions
</p>
</div>

<div id="outline-container-6-2-1" class="outline-4">
<h4 id="sec-6-2-1"><span class="section-number-4">6.2.1</span> lodge request in user db</h4>
<div class="outline-text-4" id="text-6-2-1">

<ul>
<li>new study into nceph ddiindexdb 
</li>
<li>new file with filelocation = brawns EWEDB schema, working directory
</li>
<li>in primary database record (not project) add access requestor, accessors add accessor, date to end
</li>
<li>finalise approval
</li>
</ul>

</div>

</div>

<div id="outline-container-6-2-2" class="outline-4">
<h4 id="sec-6-2-2"><span class="section-number-4">6.2.2</span> r-nceph</h4>
<div class="outline-text-4" id="text-6-2-2">

<p>production goes thru david fisher
testbed done by me
</p></div>
</div>

</div>

<div id="outline-container-6-3" class="outline-3">
<h3 id="sec-6-3"><span class="section-number-3">6.3</span> brains</h3>
<div class="outline-text-3" id="text-6-3">


</div>

<div id="outline-container-6-3-1" class="outline-4">
<h4 id="sec-6-3-1"><span class="section-number-4">6.3.1</span> linux user</h4>
<div class="outline-text-4" id="text-6-3-1">




<pre class="src src-R">adduser userxxx
passwd userxxx 
<span style="color: #586e75;"># </span><span style="color: #586e75;">(I use R to randomly generate passwords by mixing words, letters,</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">numbers and symbols) </span>
</pre>

</div>

</div>

<div id="outline-container-6-3-2" class="outline-4">
<h4 id="sec-6-3-2"><span class="section-number-4">6.3.2</span> mysql (check ddiindex)</h4>
<div class="outline-text-4" id="text-6-3-2">




<pre class="src src-R">mysql -u root -p security
select * from UserEJB;
insert into UserEJB (id, password, admin) values (<span style="color: #2aa198;">'userxxx'</span>, <span style="color: #2aa198;">'passwd'</span>, 0);
</pre>

<ul>
<li id="sec-6-3-2-1">oracle (oraphi)<br/>
<ul>
<li>log in as admin user to ddiindexdb workspace and go to administration, 
</li>
<li>on the right there is a tasks pane with create user
</li>
</ul>

</li>
</ul>
<ul>
<li id="sec-6-3-2-2">github<br/>
<ul>
<li>downstream users can just download zips from github
</li>
<li>collaborators need to sign up to github
</li>
<li>will create a walk through for those 
</li>
</ul>

</li>
</ul>
</div>
</div>

</div>

<div id="outline-container-6-4" class="outline-3">
<h3 id="sec-6-4"><span class="section-number-3">6.4</span> brawn</h3>
<div class="outline-text-3" id="text-6-4">


</div>

<div id="outline-container-6-4-1" class="outline-4">
<h4 id="sec-6-4-1"><span class="section-number-4">6.4.1</span> <span class="todo TODO">TODO</span> postgres</h4>
<div class="outline-text-4" id="text-6-4-1">

<p>Need to find out if this 0.0.0.0/0 is a big no-no?
</p>


<pre class="src src-R"><span style="color: #586e75;"># </span><span style="color: #586e75;">first edit your pg_hba.conf file</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">under /home/pgsql/9.2/data/pg_hba.conf I added a super user from my ip</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">address and allowed all the www ip addresses access</span>
host    all             postgres        my.desk.ip.address/32       md5
host    all             gislibrary      0.0.0.0/0                   md5
<span style="color: #586e75;"># </span><span style="color: #586e75;">and save.  now</span>
su - postgres
psql postgres postgres
CREATE ROLE userxxx LOGIN PASSWORD <span style="color: #2aa198;">'xxxxx'</span>;
GRANT gislibrary TO userxxx;
CREATE SCHEMA userxxx;
grant ALL on schema userxxx to userxxx;
GRANT ALL ON ALL TABLES IN SCHEMA userxxx TO userxxx;
grant ALL on all functions <span style="color: #859900; font-weight: bold;">in</span> schema userxxx to userxxx;
grant ALL on all sequences <span style="color: #859900; font-weight: bold;">in</span> schema userxxx to userxxx; 
<span style="color: #586e75;"># </span><span style="color: #586e75;">might want to set a date for expiry?  now </span>
select pg_reload_conf();
<span style="color: #586e75;"># </span><span style="color: #586e75;">or if not connected just service postgresql-9.2 restart</span>
</pre>

</div>

</div>

<div id="outline-container-6-4-2" class="outline-4">
<h4 id="sec-6-4-2"><span class="section-number-4">6.4.2</span> geoserver</h4>
<div class="outline-text-4" id="text-6-4-2">

<ul>
<li>general users don't need log in
</li>
<li>admin users can log on as admin?
</li>
</ul>

</div>

</div>

<div id="outline-container-6-4-3" class="outline-4">
<h4 id="sec-6-4-3"><span class="section-number-4">6.4.3</span> alliance wiki</h4>
<div class="outline-text-4" id="text-6-4-3">

<p><a href="https://alliance.anu.edu.au/welcome/">https://alliance.anu.edu.au/welcome/</a> 
uses their anu password
</p></div>

</div>

<div id="outline-container-6-4-4" class="outline-4">
<h4 id="sec-6-4-4"><span class="section-number-4">6.4.4</span> email details without password</h4>
<div class="outline-text-4" id="text-6-4-4">


<p>
Dear user,
</p>
<p>
The new EWEDB server is now ready.
You can configure your Kepler environment by following the tutorial at <a href="http://swish-climate-impact-assessment.github.io/2013/05/hello-ewedb/">http://swish-climate-impact-assessment.github.io/2013/05/hello-ewedb/</a>
</p>
<p>
The server details are:
 database = ewedb
 host = ipaddress
 user = user<sub>name</sub>
</p>
<p>
Your password will be sent to you as an SMS to your designated mobile phone number.
</p>
<p>
NB Please note that the connection information will be saved in plain text to your user profile. As this presents a security risk we request that you only use this service from a secure computer.
</p>
<p>
Thankyou,
Ivan Hanigan
Data Management Officer.
National Centre for Epidemiology and Population Health.
College of Medicine, Biology and Environment.
Australian National University Canberra, ACT, 0200.
Ph: +61 2 6125 7767.
Fax: +61 2 6125 0740.
Mob: 0428 265 976.
CRICOS provider #00120C.
</p>
</div>

</div>

<div id="outline-container-6-4-5" class="outline-4">
<h4 id="sec-6-4-5"><span class="section-number-4">6.4.5</span> text message the set password</h4>
<div class="outline-text-4" id="text-6-4-5">

<p>This solution is adequate.  Might want to invest in a sacrificial SIM card to avoid having too many phone calls?
</p></div>
</div>

</div>

<div id="outline-container-6-5" class="outline-3">
<h3 id="sec-6-5"><span class="section-number-3">6.5</span> edits to oraphi via sql</h3>
<div class="outline-text-3" id="text-6-5">




<pre class="src src-sh">update accessors 
<span style="color: #839496; font-weight: bold;">set</span> othermat = <span style="color: #2aa198;">'phone number'</span>
where accessornames = <span style="color: #2aa198;">'username'</span>;
</pre>



</div>

<div id="outline-container-6-5-1" class="outline-4">
<h4 id="sec-6-5-1"><span class="section-number-4">6.5.1</span> revocation</h4>
<div class="outline-text-4" id="text-6-5-1">




<pre class="src src-R">userdel -r ivan_hanigan
</pre>



</div>
</div>
</div>

</div>

<div id="outline-container-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Backups</h2>
<div class="outline-text-2" id="text-7">


</div>

<div id="outline-container-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> General</h3>
<div class="outline-text-3" id="text-7-1">


</div>

<div id="outline-container-7-1-1" class="outline-4">
<h4 id="sec-7-1-1"><span class="section-number-4">7.1.1</span> maintenance</h4>
<div class="outline-text-4" id="text-7-1-1">

</div>

</div>

<div id="outline-container-7-1-2" class="outline-4">
<h4 id="sec-7-1-2"><span class="section-number-4">7.1.2</span> nearline for potential restore</h4>
<div class="outline-text-4" id="text-7-1-2">

</div>

</div>

<div id="outline-container-7-1-3" class="outline-4">
<h4 id="sec-7-1-3"><span class="section-number-4">7.1.3</span> archive and remove</h4>
<div class="outline-text-4" id="text-7-1-3">


</div>
</div>

</div>

<div id="outline-container-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> General concerns</h3>
<div class="outline-text-3" id="text-7-2">

</div>

</div>

<div id="outline-container-7-3" class="outline-3">
<h3 id="sec-7-3"><span class="section-number-3">7.3</span> Brains</h3>
<div class="outline-text-3" id="text-7-3">


</div>

<div id="outline-container-7-3-1" class="outline-4">
<h4 id="sec-7-3-1"><span class="section-number-4">7.3.1</span> Backup oraphi</h4>
<div class="outline-text-4" id="text-7-3-1">

<p>Needs to be done from Brains as it needs the oracle client set up.
</p>


<pre class="src src-R">  <span style="color: #586e75;">###########################################################################</span>
  <span style="color: #586e75;"># </span><span style="color: #586e75;">newnode: backupOraphi</span>
  <span style="color: #586e75;"># </span><span style="color: #586e75;">using an emacs ssh buffer log on to target server, start R, start ESS-remote</span>
  <span style="color: #586e75;"># </span><span style="color: #586e75;">do this as root and put into /backups</span>
  <span style="color: #859900; font-weight: bold;">if</span>(!<span style="color: #268bd2; font-weight: bold;">require</span>(RJDBC)) install.packages(<span style="color: #2aa198;">'RJDBC'</span>); <span style="color: #268bd2; font-weight: bold;">require</span>(RJDBC)
  drv <span style="color: #268bd2; font-weight: bold;">&lt;-</span> JDBC(<span style="color: #2aa198;">"oracle.jdbc.driver.OracleDriver"</span>,
              <span style="color: #2aa198;">'/u01/app/oracle/product/11.2.0/xe/jdbc/lib/ojdbc6.jar'</span>)
  ch <span style="color: #268bd2; font-weight: bold;">&lt;-</span> dbConnect(drv,<span style="color: #2aa198;">"jdbc:oracle:thin:@xx.yy.zz.ww:1521"</span>,<span style="color: #2aa198;">"DDIINDEXDB"</span>,<span style="color: #2aa198;">"password"</span>)
  dir()
  dir.create(paste(<span style="color: #2aa198;">'ddiindexdb-backups/csvs/'</span>,Sys.Date(),sep=<span style="color: #2aa198;">''</span>),recursive=T)

  <span style="color: #859900; font-weight: bold;">for</span>( tbl <span style="color: #859900; font-weight: bold;">in</span> c(<span style="color: #2aa198;">'STDYDSCR'</span>,<span style="color: #2aa198;">'DATADSCR'</span>,<span style="color: #2aa198;">'FILEDSCR'</span>,<span style="color: #2aa198;">'KEYWORDS'</span>,<span style="color: #2aa198;">'ACCESSORS'</span>,<span style="color: #2aa198;">'ACCESSSTDY'</span>,<span style="color: #2aa198;">'OTHRSTDYMAT'</span>)){
  <span style="color: #586e75;">#</span><span style="color: #586e75;">tbl='STDYDSCR'</span>
  dataout <span style="color: #268bd2; font-weight: bold;">&lt;-</span> dbReadTable(ch, tbl)
  <span style="color: #586e75;"># </span><span style="color: #586e75;">sqlFetch(ch,tbl,as.is=T)</span>
  write.table(dataout,paste(<span style="color: #2aa198;">'ddiindexdb-backups/csvs/'</span>,Sys.Date(),<span style="color: #2aa198;">'/'</span>,tbl,<span style="color: #2aa198;">'.csv'</span>,sep=<span style="color: #2aa198;">''</span>),na = <span style="color: #2aa198;">""</span>,row.names=F,sep=<span style="color: #2aa198;">','</span>,quote=T)
  }
<span style="color: #586e75;"># </span><span style="color: #586e75;">download these to a backup location for storage.</span>

</pre>


</div>
</div>

</div>

<div id="outline-container-7-4" class="outline-3">
<h3 id="sec-7-4"><span class="section-number-3">7.4</span> Brawn</h3>
<div class="outline-text-3" id="text-7-4">


</div>

<div id="outline-container-7-4-1" class="outline-4">
<h4 id="sec-7-4-1"><span class="section-number-4">7.4.1</span> Find out how big is it?</h4>
<div class="outline-text-4" id="text-7-4-1">

<p>AKA brawn-dbsize
</p>


</div>

</div>

<div id="outline-container-7-4-2" class="outline-4">
<h4 id="sec-7-4-2"><span class="section-number-4">7.4.2</span> Dump and download it to a secure computer</h4>
<div class="outline-text-4" id="text-7-4-2">

<ul>
<li id="sec-7-4-2-1">file system backup<br/>

</li>
</ul>
<ul>
<li id="sec-7-4-2-2">backup-brawn-filesystem header<br/>


</li>
</ul>
<ul>
<li id="sec-7-4-2-3">pgdump<br/>
Backup the pg<sub>dump</sub> to your workplace or another VM on the Research Cloud.


<p>
First do this to setup the backup directory
</p>


<pre class="src src-R">mkdir /home/backup
cd /home/backup
/usr/pgsql-9.2/bin/pg_dump -U postgres ewedb | gzip &gt; ewedb_$(date +<span style="color: #2aa198;">"%F-%H%M"</span>).gz
<span style="color: #586e75;"># </span><span style="color: #586e75;">see http://www.postgresql.org/docs/9.2/static/app-pgdump.html</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">NB tried -Fc compressed version but took too long to restore</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">see http://www.postgresql.org/docs/9.2/static/backup-dump.html</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">24.1.3. Handling Large Databases</span>
</pre>


<p>
Optionally you could set up a scheduled cron job
</p>


<pre class="src src-R">cron -e
<span style="color: #586e75;"># </span><span style="color: #586e75;">15 past midnight everyday</span>
15 0 * * * /home/ewedbbackup/backup_script.sh
</pre>


<p>
Then add this script.
</p>

</li>
</ul>
</div>

</div>

<div id="outline-container-7-4-3" class="outline-4">
<h4 id="sec-7-4-3"><span class="section-number-4">7.4.3</span> Restore databse dump into a new database on another machine.</h4>
<div class="outline-text-4" id="text-7-4-3">






</div>

</div>

<div id="outline-container-7-4-4" class="outline-4">
<h4 id="sec-7-4-4"><span class="section-number-4">7.4.4</span> <span class="todo TODO">TODO</span> launch a new Nectar VM from the snapshot image</h4>
<div class="outline-text-4" id="text-7-4-4">

</div>

</div>

<div id="outline-container-7-4-5" class="outline-4">
<h4 id="sec-7-4-5"><span class="section-number-4">7.4.5</span> <span class="todo TODO">TODO</span> mount the 2nd disc and load/restore the postgres db and data into it</h4>
<div class="outline-text-4" id="text-7-4-5">



</div>
</div>

</div>

<div id="outline-container-7-5" class="outline-3">
<h3 id="sec-7-5"><span class="section-number-3">7.5</span> Disaster Recovery Plan</h3>
<div class="outline-text-3" id="text-7-5">


</div>

<div id="outline-container-7-5-1" class="outline-4">
<h4 id="sec-7-5-1"><span class="section-number-4">7.5.1</span> test a snapshot</h4>
<div class="outline-text-4" id="text-7-5-1">

<p>should test snapshots 3-monthly?
</p>
<ul>
<li id="sec-7-5-1-1">cleaning up links on github<br/>
in case of a completely failed VM, launching a fresh VM from snapshot will give a different IP-address and so Github and other links, and user's bookmarks will need to be revised.
</li>
</ul>
</div>

</div>

<div id="outline-container-7-5-2" class="outline-4">
<h4 id="sec-7-5-2"><span class="section-number-4">7.5.2</span> <span class="todo TODO">TODO</span> 60GB disk is not being saved in snapshots</h4>
<div class="outline-text-4" id="text-7-5-2">

<p>Will also need to investigate the restore procedure (and security) for the secondary disc.
</p></div>

</div>

<div id="outline-container-7-5-3" class="outline-4">
<h4 id="sec-7-5-3"><span class="section-number-4">7.5.3</span> <span class="todo TODO">TODO</span> Restore ORAPHI</h4>
<div class="outline-text-4" id="text-7-5-3">

<p>This should have restored ok with data intact from the last snapshot.
If not first set up oracle and the tables.
Get the most recent backup of the tables.
Load the tables to the new ORAPHI.
In the event of an upgrade to a tested replacement you may find that the contents on the running VM that is getting retired is more current than the old stuff in the replacement tested server so will need to sync.
</p></div>
</div>
</div>

</div>

<div id="outline-container-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Examples</h2>
<div class="outline-text-2" id="text-8">


</div>

<div id="outline-container-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> Pumilio for Bioacoustics</h3>
<div class="outline-text-3" id="text-8-1">














</div>
</div>
</div>
</div>

</body>
</html>
